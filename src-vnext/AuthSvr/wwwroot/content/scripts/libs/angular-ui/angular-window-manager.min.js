"use strict";angular.module("ngWindowManager",[]).directive("wmwindow",function(){return{template:'<div class="wmWindow"><div class="wmWindowBox"><div class="wmTitleBar"><div class="wmTitle">{{title}}<\/div><div class="wmButtonBar"><button class="wmMaximize" ng-show="isMaximizable()"><button style="display:none" class="wmRestore"/><button class="wmClose" ng-show="isCloseable()" /><\/div><\/div><div class="wmContent" data-ng-transclude ><\/div><button  class="wmResize" /><\/div><\/div>',restrict:"E",replace:!0,transclude:!0,scope:{title:"@",close:"=",open:"=",selectwindow:"=",maximize:"=",restore:"=",options:"@",maximizable:"@",closeable:"@"},link:function(n,t){var o=t[0].parentElement,r=t[0].children[0].children[0],p=t[0].children[0].children[1],l=t[0].children[0].children[2],w=r.children[1],u=w.children[0],b=w.children[2],s=null,h=null,c=null,i={},e,f,y,tt,it;i.elem=t;e=n.options?JSON.parse(n.options):{};f=e.windowContainer===undefined?o:document.getElementById(e.windowContainer);o.topZ=o.topZ||e.initialZIndex||angular.element(o).css("z-index")||1e5;i.close=function(){setTimeout(function(){t.addClass("closing");setTimeout(function(){t.removeClass("closing");t.remove()},300)},50);n.close&&n.close(i)};n.isMaximizable=function(){return n.maximizable===undefined||n.maximizable===!0||n.maximizable==="true"?!0:!1};n.isCloseable=function(){return n.closeable===undefined||n.closeable===!0||n.closeable==="true"?!0:!1};var a=function(n){var r=n.targetTouches&&n.targetTouches.length===1,u=r?n.targetTouches[0]:n;s=rt({x:u.pageX,y:u.pageY});t.addClass("moving");f.addEventListener(r?"touchmove":"mousemove",k);f.addEventListener(r?"touchend":"mouseup",g);i.selectWindow();n.preventDefault()},v=function(n){var r=n.targetTouches&&n.targetTouches.length===1,u=r?n.targetTouches[0]:n;h=ut({width:u.pageX,height:u.pageY});t.addClass("resizing");f.addEventListener(r?"touchmove":"mousemove",d);f.addEventListener(r?"touchend":"mouseup",nt);i.selectWindow();n.preventDefault()},k=function(n){var t=n.targetTouches&&n.targetTouches.length===1?n.targetTouches[0]:n;s&&i.move(t.pageX-s.x,t.pageY-s.y);n.preventDefault()},d=function(n){var t=n.targetTouches&&n.targetTouches.length===1?n.targetTouches[0]:n;h&&i.resize(t.pageX+h.width,t.pageY+h.height);n.preventDefault()},g=function(n){var u=n.targetTouches&&n.targetTouches.length===1;s&&(t.removeClass("moving"),s=null);f.removeEventListener(u?"touchmove":"mousemove",k);f.removeEventListener(u?"touchend":"mouseup",g);r.removeEventListener("click",i.selectWindow);n.preventDefault()},nt=function(n){var i=n.targetTouches&&n.targetTouches.length===1;h&&(t.removeClass("resizing"),h=null);f.removeEventListener(i?"touchmove":"mousemove",d);f.removeEventListener(i?"touchend":"mouseup",nt);n.preventDefault()},rt=function(n){var i=parseInt(t.prop("offsetLeft"),10),r=parseInt(t.prop("offsetTop"),10);return{x:n.x-i,y:n.y-r}},ut=function(n){var i=parseInt(t.prop("offsetWidth"),10),r=parseInt(t.prop("offsetHeight"),10);return{width:i-n.width,height:r-n.height}};i.move=function(n,i){n&&t.css("left",n+"px");i&&t.css("top",i+"px")};i.resize=function(n,i){n&&t.css("width",n+"px");i&&t.css("height",i+"px")};i.selectWindow=function(){o.topZ=o.topZ+1;t.css("z-index",o.topZ);n.selectwindow&&n.selectwindow(i)};i.getMaximizeToElement=function(){if(e.maximizeTo!=="window"){var n=document.getElementById(e.maximizeTo)||document.getElementsByTagName(e.maximizeTo);return e.maximizeTo?n:f}return window};i.maximize=function(){c={x:parseInt(t.prop("offsetLeft"),10),y:parseInt(t.prop("offsetTop"),10),width:parseInt(t.prop("offsetWidth"),10),height:parseInt(t.prop("offsetHeight"),10),z:t.css("z-index")};var f=i.getMaximizeToElement(),e={x:parseInt(f.offsetLeft||0,10),y:parseInt(f.offsetTop||0,10),width:parseInt(f.offsetWidth||f.innerWidth,10),height:parseInt(f.offsetHeight||f.innerHeight,10)};i.move(e.x+10,e.y+10);t.addClass("maximizing");t.addClass("maximized");i.resize(e.width-20,e.height-20);u.removeEventListener("click",i.maximize);u.removeEventListener("touchstart",i.maximize);u.addEventListener("click",i.restore);u.addEventListener("touchstart",i.restore);r.removeEventListener("dblclick",i.maximize);r.addEventListener("dblclick",i.restore);tt();setTimeout(function(){t.removeClass("maximizing")},500);n.maximize&&n.maximize(i)};i.restore=function(){t.addClass("restoring");t.removeClass("maximized");i.move(c.x,c.y);i.resize(c.width,c.height);t.css("z-index",c.z);u.removeEventListener("click",i.restore);u.removeEventListener("touchstart",i.restore);u.addEventListener("click",i.maximize);u.addEventListener("touchstart",i.maximize);r.removeEventListener("dblclick",i.restore);r.addEventListener("dblclick",i.maximize);y();n.restore&&n.restore(i);setTimeout(function(){t.removeClass("restoring")},500)};y=function(){r.addEventListener("mousedown",a);r.addEventListener("touchstart",a);l.addEventListener("mousedown",v);l.addEventListener("touchstart",v);p.addEventListener("click",i.selectWindow)};tt=function(){r.removeEventListener("mousedown",a);r.removeEventListener("touchstart",a);l.removeEventListener("mousedown",v);l.removeEventListener("touchstart",v);p.removeEventListener("click",i.selectWindow)};y();b.addEventListener("click",i.close);b.addEventListener("touchstart",i.close);u.addEventListener("click",i.maximize);u.addEventListener("touchstart",i.maximize);n.maximizable&&r.addEventListener("dblclick",i.maximize);it=function(n,t){var i,r;t.position&&(i=t.position,n.move(i.x,i.y));t.size&&(r=t.size,n.resize(r.width,r.height))};it(i,e);setTimeout(function(){t.addClass("active");t.addClass("opening");i.selectWindow();setTimeout(function(){t.removeClass("opening");n.open&&n.open(i)},400)},50)}}});