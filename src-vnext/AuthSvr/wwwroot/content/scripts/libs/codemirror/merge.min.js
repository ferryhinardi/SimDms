(function(n){typeof exports=="object"&&typeof module=="object"?n(require("../../lib/codemirror")):typeof define=="function"&&define.amd?define(["../../lib/codemirror","diff_match_patch"],n):n(CodeMirror)})(function(n){"use strict";function o(n,t){this.mv=n;this.type=t;this.classes=t=="left"?{chunk:"CodeMirror-merge-l-chunk",start:"CodeMirror-merge-l-chunk-start",end:"CodeMirror-merge-l-chunk-end",insert:"CodeMirror-merge-l-inserted",del:"CodeMirror-merge-l-deleted",connect:"CodeMirror-merge-l-connect"}:{chunk:"CodeMirror-merge-r-chunk",start:"CodeMirror-merge-r-chunk-start",end:"CodeMirror-merge-r-chunk-end",insert:"CodeMirror-merge-r-inserted",del:"CodeMirror-merge-r-deleted",connect:"CodeMirror-merge-r-connect"}}function u(t){t.diffOutOfDate&&(t.diff=rt(t.orig.getValue(),t.edit.getValue()),t.chunks=ut(t.diff),t.diffOutOfDate=!1,n.signal(t.edit,"updateDiff",t.diff))}function ct(n){function s(e){f=!0;o=!1;e=="full"&&(n.svg&&h(n.svg),n.copyButtons&&h(n.copyButtons),a(n.edit,t.marked,n.classes),a(n.orig,i.marked,n.classes),t.from=t.to=i.from=i.to=0);u(n);n.showDifferences&&(g(n.edit,n.diff,t,DIFF_INSERT,n.classes),g(n.orig,n.diff,i,DIFF_DELETE,n.classes));r(n);n.mv.options.connect=="align"&&y(n);f=!1}function e(t){f||(n.dealigned=!0,c(t))}function c(n){f||o||(clearTimeout(l),n===!0&&(o=!0),l=setTimeout(s,n===!0?20:250))}function v(r,u){n.diffOutOfDate||(n.diffOutOfDate=!0,t.from=t.to=i.from=i.to=0);e(u.text.length-1!=u.to.line-u.from.line)}var t={from:0,to:0,marked:[]},i={from:0,to:0,marked:[]},l,o=!1;n.edit.on("change",v);n.orig.on("change",v);n.edit.on("markerAdded",e);n.edit.on("markerCleared",e);n.orig.on("markerAdded",e);n.orig.on("markerCleared",e);n.edit.on("viewportChange",function(){c(!1)});n.orig.on("viewportChange",function(){c(!1)});return s(),s}function lt(n){n.edit.on("scroll",function(){l(n,DIFF_INSERT)&&r(n)});n.orig.on("scroll",function(){l(n,DIFF_DELETE)&&r(n)})}function l(n,t){var u,f,l,i,s,p;if(n.diffOutOfDate)return!1;if(!n.lockScroll)return!0;if(l=+new Date,t==DIFF_INSERT?(u=n.edit,f=n.orig):(u=n.orig,f=n.edit),u.state.scrollSetBy==n&&(u.state.scrollSetAt||0)+50>l)return!1;if(i=u.getScrollInfo(),n.mv.options.connect=="align")r=i.top;else{var o=.5*i.clientHeight,y=i.top+o,w=u.lineAtHeight(y,"local"),h=wt(n.chunks,w,t==DIFF_INSERT),a=k(u,t==DIFF_INSERT?h.edit:h.orig),v=k(f,t==DIFF_INSERT?h.orig:h.edit),b=(y-a.top)/(a.bot-a.top),r=v.top-o+b*(v.bot-v.top),c,e;r>i.top&&(e=i.top/o)<1?r=r*e+i.top*(1-e):(c=i.height-i.clientHeight-i.top)<o&&(s=f.getScrollInfo(),p=s.height-s.clientHeight-r,p>c&&(e=c/o)<1&&(r=r*e+(s.height-s.clientHeight-c)*(1-e)))}return f.scrollTo(i.left,r),f.state.scrollSetAt=l,f.state.scrollSetBy=n,!0}function k(n,t){var i=t.after;return i==null&&(i=n.lastLine()+1),{top:n.heightAtLine(t.before||0,"local"),bot:n.heightAtLine(i,"local")}}function d(n,t,i){n.lockScroll=t;t&&i!=!1&&l(n,DIFF_INSERT)&&r(n);n.lockButton.innerHTML=t?"⇛⇚":"⇛&nbsp;&nbsp;⇚"}function a(t,i,r){for(var u,f=0;f<i.length;++f)u=i[f],u instanceof n.TextMarker?u.clear():u.parent&&(t.removeLineClass(u,"background",r.chunk),t.removeLineClass(u,"background",r.start),t.removeLineClass(u,"background",r.end));i.length=0}function g(n,t,i,r,u){var f=n.getViewport();n.operation(function(){i.from==i.to||f.from-i.to>20||i.from-f.to>20?(a(n,i.marked,u),v(n,t,r,i.marked,f.from,f.to,u),i.from=f.from,i.to=f.to):(f.from<i.from&&(v(n,t,r,i.marked,f.from,i.from,u),i.from=f.from),f.to>i.to&&(v(n,t,r,i.marked,i.to,f.to,u),i.to=f.to))})}function v(n,i,r,u,f,e,o){function y(t,i){for(var h,r=Math.max(f,t),c=Math.min(e,i),s=r;s<c;++s)h=n.addLineClass(s,"background",o.chunk),s==t&&n.addLineClass(h,"background",o.start),s==i-1&&n.addLineClass(h,"background",o.end),u.push(h);t==i&&r==i&&c==i&&(r?u.push(n.addLineClass(r-1,"background",o.end)):u.push(n.addLineClass(r,"background",o.start)))}for(var a,v,s=t(0,0),nt=t(f,0),tt=n.clipPos(t(e-1)),it=r==DIFF_DELETE?o.del:o.insert,l=0,h=0;h<i.length;++h){var p=i[h],w=p[0],b=p[1];if(w==DIFF_EQUAL)a=s.line+(et(i,h)?0:1),c(s,b),v=s.line+(ft(i,h)?1:0),v>a&&(h&&y(l,a),l=v);else if(w==r){var k=c(s,b,!0),d=ni(nt,s),g=gt(tt,k);ti(d,g)||u.push(n.markText(d,g,{className:it}));s=k}}l<=s.line&&y(l,s.line+1)}function r(n){var r,i,t;if(n.showDifferences){n.svg&&(h(n.svg),r=n.gap.offsetWidth,st(n.svg,"width",r,"height",n.gap.offsetHeight));n.copyButtons&&h(n.copyButtons);var u=n.edit.getViewport(),f=n.orig.getViewport(),e=n.edit.getScrollInfo().top,o=n.orig.getScrollInfo().top;for(i=0;i<n.chunks.length;i++)t=n.chunks[i],t.editFrom<=u.to&&t.editTo>=u.from&&t.origFrom<=f.to&&t.origTo>=f.from&&pt(n,t,o,e,r)}}function s(n,t){for(var i,u=0,f=0,r=0;r<t.length;r++){if(i=t[r],i.editTo>n&&i.editFrom<=n)return null;if(i.editFrom>n)break;u=i.editTo;f=i.origTo}return f+(n-u)}function at(n,t){for(var i,u,e,f=[],r=0;r<n.chunks.length;r++)i=n.chunks[r],f.push([i.origTo,i.editTo,t?s(i.editTo,t.chunks):null]);if(t)for(r=0;r<t.chunks.length;r++){for(i=t.chunks[r],u=0;u<f.length;u++)if(e=f[u],e[1]==i.editTo){u=-1;break}else if(e[1]>i.editTo)break;u>-1&&f.splice(u-1,0,[s(i.editTo,n.chunks),i.editTo,i.origTo])}return f}function y(n,t){var r,s,e,f,h,o,i;if(n.dealigned||t){if(!n.orig.curOp)return n.orig.operation(function(){y(n,t)});for(n.dealigned=!1,r=n.mv.left==n?n.mv.right:n.mv.left,r&&(u(r),r.dealigned=!1),s=at(n,r),e=n.mv.aligners,i=0;i<e.length;i++)e[i].clear();for(e.length=0,f=[n.orig,n.edit],h=[],r&&f.push(r.orig),i=0;i<f.length;i++)h.push(f[i].getScrollInfo().top);for(o=0;o<s.length;o++)vt(f,s[o],e);for(i=0;i<f.length;i++)f[i].scrollTo(null,h[i])}}function vt(n,t,i){for(var f,e,u=0,o=[],r=0;r<n.length;r++)t[r]!=null&&(f=n[r].heightAtLine(t[r],"local"),o[r]=f,u=Math.max(u,f));for(r=0;r<n.length;r++)t[r]!=null&&(e=u-o[r],e>1&&i.push(yt(n[r],t[r],e)))}function yt(n,t,i){var u=!0,r;return t>n.lastLine()&&(t--,u=!1),r=document.createElement("div"),r.className="CodeMirror-merge-spacer",r.style.height=i+"px",r.style.minWidth="1px",n.addLineWidget(t,r,{height:i,above:u})}function pt(n,t,r,u,f){var y=n.type=="left",p=n.orig.heightAtLine(t.origFrom,"local")-r,o,s,h,c,l,w,k,a,v,d,e;n.svg&&(o=p,s=n.edit.heightAtLine(t.editFrom,"local")-u,y&&(l=o,o=s,s=l),h=n.orig.heightAtLine(t.origTo,"local")-r,c=n.edit.heightAtLine(t.editTo,"local")-u,y&&(l=h,h=c,c=l),w=" C "+f/2+" "+s+" "+f/2+" "+o+" "+(f+2)+" "+o,k=" C "+f/2+" "+h+" "+f/2+" "+c+" -1 "+c,st(n.svg.appendChild(document.createElementNS(b,"path")),"d","M -1 "+s+w+" L "+(f+2)+" "+h+k+" z","class",n.classes.connect));n.copyButtons&&(a=n.copyButtons.appendChild(i("div",n.type=="left"?"⇝":"⇜","CodeMirror-merge-copy")),v=n.mv.options.allowEditingOriginals,a.title=v?"Push to left":"Revert chunk",a.chunk=t,a.style.top=p+"px",v&&(d=n.orig.heightAtLine(t.editFrom,"local")-u,e=n.copyButtons.appendChild(i("div",n.type=="right"?"⇝":"⇜","CodeMirror-merge-copy-reverse")),e.title="Push to right",e.chunk={editFrom:t.origFrom,editTo:t.origTo,origFrom:t.editFrom,origTo:t.editTo},e.style.top=d+"px",n.type=="right"?e.style.left="2px":e.style.right="2px"))}function nt(n,i,r,u){n.diffOutOfDate||i.replaceRange(r.getRange(t(u.origFrom,0),t(u.origTo,0)),t(u.editFrom,0),t(u.editTo,0))}function tt(t){var f=t.lockButton=i("div",null,"CodeMirror-merge-scrolllock"),e,u,r;f.title="Toggle locked scrolling";e=i("div",[f],"CodeMirror-merge-scrolllock-wrap");n.on(f,"click",function(){d(t,!t.lockScroll)});if(u=[e],t.mv.options.revertButtons!==!1){t.copyButtons=i("div",null,"CodeMirror-merge-copybuttons-"+t.type);n.on(t.copyButtons,"click",function(n){var i=n.target||n.srcElement;if(i.chunk){if(i.className=="CodeMirror-merge-copy-reverse"){nt(t,t.orig,t.edit,i.chunk);return}nt(t,t.edit,t.orig,i.chunk)}});u.unshift(t.copyButtons)}return t.mv.options.connect!="align"&&(r=document.createElementNS&&document.createElementNS(b,"svg"),r&&!r.createSVGRect&&(r=null),t.svg=r,r&&u.push(r)),t.gap=i("div",u,"CodeMirror-merge-gap")}function it(n){return typeof n=="string"?n:n.getValue()}function rt(n,t){var r=p.diff_main(n,t),i,u;for(p.diff_cleanupSemantic(r),i=0;i<r.length;++i)u=r[i],u[1]?i&&r[i-1][0]==u[0]&&(r.splice(i--,1),r[i][1]+=u[1]):r.splice(i--,1);return r}function ut(n){for(var o,h,s=[],f=0,e=0,i=t(0,0),r=t(0,0),u=0;u<n.length;++u)if(o=n[u],h=o[0],h==DIFF_EQUAL){var l=et(n,u)?0:1,a=i.line+l,p=r.line+l;c(i,o[1],null,r);var v=ft(n,u)?1:0,y=i.line+v,w=r.line+v;y>a&&(u&&s.push({origFrom:e,origTo:p,editFrom:f,editTo:a}),f=y,e=w)}else c(h==DIFF_INSERT?i:r,o[1]);return(f<=i.line||e<=r.line)&&s.push({origFrom:e,origTo:r.line+1,editFrom:f,editTo:i.line+1}),s}function ft(n,t){if(t==n.length-1)return!0;var i=n[t+1][1];return i.length==1||i.charCodeAt(0)!=10?!1:t==n.length-2?!0:(i=n[t+2][1],i.length>1&&i.charCodeAt(0)==10)}function et(n,t){if(t==0)return!0;var i=n[t-1][1];return i.charCodeAt(i.length-1)!=10?!1:t==1?!0:(i=n[t-2][1],i.charCodeAt(i.length-1)==10)}function wt(n,t,i){for(var f,u,e,o,s=0;s<n.length;s++){var r=n[s],h=i?r.editFrom:r.origFrom,c=i?r.editTo:r.origTo;u==null&&(h>t?(u=r.editFrom,o=r.origFrom):c>t&&(u=r.editTo,o=r.origTo));c<=t?(f=r.editTo,e=r.origTo):h<=t&&(f=r.editFrom,e=r.origFrom)}return{edit:{before:f,after:u},orig:{before:e,after:o}}}function bt(i,r,u){function o(){e.clear();i.removeLineClass(r,"wrap","CodeMirror-merge-collapsed-line")}var f,e;i.addLineClass(r,"wrap","CodeMirror-merge-collapsed-line");f=document.createElement("span");f.className="CodeMirror-merge-collapsed-widget";f.title="Identical text collapsed. Click to expand.";e=i.markText(t(r,0),t(u-1),{inclusiveLeft:!0,inclusiveRight:!0,replacedWith:f,clearOnEnter:!0});n.on(f,"click",o);return{mark:e,clear:o}}function kt(n,t){function e(){for(var n=0;n<i.length;n++)i[n].clear()}for(var r,f,i=[],u=0;u<t.length;u++){r=t[u];f=bt(r.cm,r.line,r.line+n);i.push(f);f.mark.on("clear",e)}return i[0].mark}function ot(n,t,i,r){for(var o,f,e,u=0;u<n.chunks.length;u++)for(o=n.chunks[u],f=o.editFrom-t;f<o.editTo+t;f++)e=f+i,e>=0&&e<r.length&&(r[e]=!1)}function dt(n,t){var c,l,i,u,f,o,a;typeof t!="number"&&(t=2);var r=[],h=n.editor(),e=h.firstLine();for(c=e,l=h.lastLine();c<=l;c++)r.push(!0);for(n.left&&ot(n.left,t,e,r),n.right&&ot(n.right,t,e,r),i=0;i<r.length;i++)if(r[i]){for(u=i+e,f=1;i<r.length-1&&r[i+1];i++,f++);if(f>t&&(o=[{line:u,cm:h}],n.left&&o.push({line:s(u,n.left.chunks),cm:n.left.orig}),n.right&&o.push({line:s(u,n.right.chunks),cm:n.right.orig}),a=kt(f,o),n.options.onCollapse))n.options.onCollapse(n,u,f,a)}}function i(n,t,i,r){var u=document.createElement(n),f;if(i&&(u.className=i),r&&(u.style.cssText=r),typeof t=="string")u.appendChild(document.createTextNode(t));else if(t)for(f=0;f<t.length;++f)u.appendChild(t[f]);return u}function h(n){for(var t=n.childNodes.length;t>0;--t)n.removeChild(n.firstChild)}function st(n){for(var t=1;t<arguments.length;t+=2)n.setAttribute(arguments[t],arguments[t+1])}function w(n,t){t||(t={});for(var i in n)n.hasOwnProperty(i)&&(t[i]=n[i]);return t}function c(n,i,r,u){for(var e=r?t(n.line,n.ch):n,f=0,o;;){if(o=i.indexOf("\n",f),o==-1)break;++e.line;u&&++u.line;f=o+1}return e.ch=(f?0:e.ch)+(i.length-f),u&&(u.ch=(f?0:u.ch)+(i.length-f)),e}function gt(n,t){return(n.line-t.line||n.ch-t.ch)<0?n:t}function ni(n,t){return(n.line-t.line||n.ch-t.ch)>0?n:t}function ti(n,t){return n.line==t.line&&n.ch==t.ch}function ii(n,t,i){for(var u,f,r=n.length-1;r>=0;r--)if(u=n[r],f=(i?u.origTo:u.editTo)-1,f<t)return f}function ri(n,t,i){for(var u,f,r=0;r<n.length;r++)if(u=n[r],f=i?u.origFrom:u.editFrom,f>t)return f}function ht(t,i){var r=null,s=t.state.diffViews,c=t.getCursor().line,o,f,h,e;if(s)for(o=0;o<s.length;o++)f=s[o],h=t==f.orig,u(f),e=i<0?ii(f.chunks,c,h):ri(f.chunks,c,h),e!=null&&(r==null||(i<0?e>r:e<r))&&(r=e);if(r!=null)t.setCursor(r,0);else return n.Pass}var t=n.Pos,b="http://www.w3.org/2000/svg",f,e,p;o.prototype={constructor:o,init:function(t,i,r){this.edit=this.mv.edit;(this.edit.state.diffViews||(this.edit.state.diffViews=[])).push(this);this.orig=n(t,w({value:i,readOnly:!this.mv.options.allowEditingOriginals},w(r)));this.orig.state.diffViews=[this];this.diff=rt(it(i),it(r.value));this.chunks=ut(this.diff);this.diffOutOfDate=this.dealigned=!1;this.showDifferences=r.showDifferences!==!1;this.forceUpdate=ct(this);d(this,!0,!1);lt(this)},setShowDifferences:function(n){n=n!==!1;n!=this.showDifferences&&(this.showDifferences=n,this.forceUpdate("full"))}};f=!1;e=n.MergeView=function(t,u){var v,c,l,g,p,nt;if(!(this instanceof e))return new e(t,u);this.options=u;var b=u.origLeft,k=u.origRight==null?u.orig:u.origRight,d=b!=null,a=k!=null,it=1+(d?1:0)+(a?1:0),f=[],s=this.left=null,h=this.right=null,rt=this;d&&(s=this.left=new o(this,"left"),v=i("div",null,"CodeMirror-merge-pane"),f.push(v),f.push(tt(s)));c=i("div",null,"CodeMirror-merge-pane");f.push(c);a&&(h=this.right=new o(this,"right"),f.push(tt(h)),l=i("div",null,"CodeMirror-merge-pane"),f.push(l));(a?l:c).className+=" CodeMirror-merge-pane-rightmost";f.push(i("div",null,null,"height: 0; clear: both;"));g=this.wrap=t.appendChild(i("div",f,"CodeMirror-merge CodeMirror-merge-"+it+"pane"));this.edit=n(c,w(u));s&&s.init(v,b,u);h&&h.init(l,k,u);u.collapseIdentical&&this.editor().operation(function(){dt(rt,u.collapseIdentical)});u.connect=="align"&&(this.aligners=[],y(this.left||this.right,!0));p=function(){s&&r(s);h&&r(h)};n.on(window,"resize",p);nt=setInterval(function(){for(var t=g.parentNode;t&&t!=document.body;t=t.parentNode);t||(clearInterval(nt),n.off(window,"resize",p))},5e3)};e.prototype={constuctor:e,editor:function(){return this.edit},rightOriginal:function(){return this.right&&this.right.orig},leftOriginal:function(){return this.left&&this.left.orig},setShowDifferences:function(n){this.right&&this.right.setShowDifferences(n);this.left&&this.left.setShowDifferences(n)},rightChunks:function(){if(this.right)return u(this.right),this.right.chunks},leftChunks:function(){if(this.left)return u(this.left),this.left.chunks}};p=new diff_match_patch;n.commands.goNextDiff=function(n){return ht(n,1)};n.commands.goPrevDiff=function(n){return ht(n,-1)}});
//# sourceMappingURL=merge.min.js.map
