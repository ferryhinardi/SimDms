(function(n){if(typeof exports=="object"&&typeof module=="object")return n(require("../lib/infer"),require("../lib/tern"),require("../lib/comment"),require("acorn/acorn"),require("acorn/util/walk"));if(typeof define=="function"&&define.amd)return define(["../lib/infer","../lib/tern","../lib/comment","acorn/acorn","acorn/util/walk"],n);n(tern,tern,tern.comment,acorn,acorn.walk)})(function(n,t,i,r,u){"use strict";function p(n,t){function r(n){i.ensureCommentsBefore(t,n)}u.simple(n,{VariableDeclaration:r,FunctionDeclaration:r,AssignmentExpression:function(n){n.operator=="="&&r(n)},ObjectExpression:function(n){for(var t=0;t<n.properties.length;++t)r(n.properties[t])},CallExpression:function(n){h(n)&&r(n)}})}function h(n){return n.callee.type=="MemberExpression"&&n.callee.object.name=="Object"&&n.callee.property.name=="defineProperty"&&n.arguments.length>=3&&typeof n.arguments[1].value=="string"}function w(t,i){nt(t.sourceFile.text,i);u.simple(t,{VariableDeclaration:function(n,t){n.commentsBefore&&o(n,n.commentsBefore,t,t.getProp(n.declarations[0].id.name))},FunctionDeclaration:function(n,t){n.commentsBefore&&o(n,n.commentsBefore,t,t.getProp(n.id.name),n.body.scope.fnType)},AssignmentExpression:function(t,i){t.commentsBefore&&o(t,t.commentsBefore,i,n.expressionType({node:t.left,state:i}))},ObjectExpression:function(n,t){for(var i,r=0;r<n.properties.length;++r)i=n.properties[r],i.commentsBefore&&o(i,i.commentsBefore,t,n.objType.getProp(i.key.name))},CallExpression:function(t,i){var r,u;t.commentsBefore&&h(t)&&(r=n.expressionType({node:t.arguments[0],state:i}).getObjType(),r&&r instanceof n.Obj&&(u=r.props[t.arguments[1].value],u&&o(t,t.commentsBefore,i,u)))}},n.searchVisitor,i)}function b(t){var r=t["!typedef"],u=n.cx(),f=t["!name"],i;if(r)for(i in r)u.parent.jsdocTypedefs[i]=l(n.def.parse(r[i],f,i),i)}function o(t,i,r,u,f){var o,e,s;g(t,r,u,i);o=n.cx();!f&&u instanceof n.AVal&&u.types.length&&(f=u.types[u.types.length-1],f instanceof n.Obj&&f.origin==o.curOrigin&&!f.doc||(f=null));e=i[i.length-1];o.parent._docComment.fullDocs?e=e.trim().replace(/\n[ \t]*\* ?/g,"\n"):(s=e.search(/\.\s/),s>5&&(e=e.slice(0,s+1)),e=e.trim().replace(/\s*\n\s*\*\s*|\s{1,}/g," "));e=e.replace(/^\s*\*+\s*/,"");u instanceof n.AVal&&(u.doc=e);f&&(f.doc=e)}function f(n,t){while(/\s/.test(n.charAt(t)))++t;return t}function k(n){if(!r.isIdentifierStart(n.charCodeAt(0)))return!1;for(var t=1;t<n.length;t++)if(!r.isIdentifierChar(n.charCodeAt(t)))return!1;return!0}function c(n,t,i,r){for(var o,h,u,c,l=[],a=[],s=!1,v=!0;;v=!1){if(i=f(t,i),v&&t.charAt(i)==r)break;if((o=t.indexOf(":",i),o<0)||(h=t.slice(i,o),!k(h))||(l.push(h),i=o+1,u=e(n,t,i),!u))return null;if(i=u.end,s=s||u.madeUp,a.push(u.type),i=f(t,i),c=t.charAt(i),++i,c==r)break;if(c!=",")return null}return{labels:l,types:a,end:i,madeUp:s}}function e(t,i,r){for(var o,u=!1,s=!1,e,h;;){if(e=d(t,i,r),!e)return null;if(s=s||e.madeUp,u?e.type.propagate(u):o=e.type,r=f(i,e.end),i.charAt(r)!="|")break;r++;u||(u=new n.AVal,o.propagate(u),o=u)}return h=!1,i.charAt(r)=="="&&(++r,h=!0),{type:o,end:r,isOptional:h,madeUp:s}}function d(t,i,u){var o,h,w,it,b,v,k,rt,tt,y,s,d,g,nt;if(u=f(i,u),h=!1,i.indexOf("function(",u)==u){if(w=c(t,i,u+9,")"),it=n.ANull,!w)return null;if(u=f(i,w.end),i.charAt(u)==":"){if(++u,b=e(t,i,u+1),!b)return null;u=b.end;it=b.type;h=b.madeUp}o=new n.Fn(null,n.ANull,w.types,w.labels,it)}else if(i.charAt(u)=="["){if((s=e(t,i,u+1),!s)||(u=f(i,s.end),h=s.madeUp,i.charAt(u)!="]"))return null;++u;o=new n.Arr(s.type)}else if(i.charAt(u)=="{"){if(v=c(t,i,u+1,"}"),!v)return null;for(o=new n.Obj(!0),k=0;k<v.types.length;++k)rt=o.defProp(v.labels[k]),rt.initializer=!0,v.types[k].propagate(rt);u=v.end;h=v.madeUp}else if(i.charAt(u)=="("){if((s=e(t,i,u+1),!s)||(u=f(i,s.end),i.charAt(u)!=")"))return null;++u;o=s.type}else{if(tt=u,!r.isIdentifierStart(i.charCodeAt(u)))return null;while(r.isIdentifierChar(i.charCodeAt(u)))++u;if(tt==u)return null;if(y=i.slice(tt,u),/^(number|integer)$/i.test(y))o=n.cx().num;else if(/^bool(ean)?$/i.test(y))o=n.cx().bool;else if(/^string$/i.test(y))o=n.cx().str;else if(/^(null|undefined)$/i.test(y))o=n.ANull;else if(/^array$/i.test(y)){if(s=null,i.charAt(u)=="."&&i.charAt(u+1)=="<"){if((d=e(t,i,u+2),!d)||(u=f(i,d.end),h=d.madeUp,i.charAt(u++)!=">"))return null;s=d.type}o=new n.Arr(s)}else if(/^object$/i.test(y)){if(o=new n.Obj(!0),i.charAt(u)=="."&&i.charAt(u+1)=="<"){if((g=e(t,i,u+2),!g)||(u=f(i,g.end),h=h||g.madeUp,i.charAt(u++)!=",")||(nt=e(t,i,u),!nt)||(u=f(i,nt.end),h=g.madeUp||nt.madeUp,i.charAt(u++)!=">"))return null;nt.type.propagate(o.defProp("<i>"))}}else{while(i.charCodeAt(u)==46||r.isIdentifierChar(i.charCodeAt(u)))++u;var a=i.slice(tt,u),p=n.cx(),ut=p.parent&&p.parent.jsdocTypedefs,ft;ut&&a in ut?o=ut[a]:(ft=n.def.parsePath(a,t).getObjType())?o=l(ft,a):(p.jsdocPlaceholders||(p.jsdocPlaceholders=Object.create(null)),o=a in p.jsdocPlaceholders?p.jsdocPlaceholders[a]:p.jsdocPlaceholders[a]=new n.Obj(null,a),h=!0)}}return{type:o,end:u,madeUp:h}}function l(t,i){if(t instanceof n.Fn&&/^[A-Z]/.test(i)){var r=t.getProp("prototype").getObjType();if(r instanceof n.Obj)return n.getInstance(r)}return t}function a(n,t,i){var r,u;return(i=f(t,i||0),t.charAt(i)!="{")?null:(r=e(n,t,i+1),!r)?null:(u=f(t,r.end),t.charAt(u)!="}")?null:(r.end=u+1,r)}function g(n,t,i,r){for(var p,w,f,o,b,l,s,v,h,y,u,c=0;c<r.length;++c)for(p=r[c],w=/(?:\n|$|\*)\s*@(type|param|arg(?:ument)?|returns?|this)\s+(.*)/g;f=w.exec(p);){if(f[1]=="this"&&(u=e(t,f[2],0))){y=u;h=!0;continue}if(u=a(t,f[2])){h=!0;switch(f[1]){case"returns":case"return":v=u;break;case"type":l=u;break;case"param":case"arg":case"argument":if(o=f[2].slice(u.end).match(/^\s*(\[?)\s*([^\]\s]+)\s*(\]?).*/),!o)continue;b=o[2]+(u.isOptional||o[1]==="["&&o[3]==="]"?"?":"");(s||(s=Object.create(null)))[b]=u}}}h&&tt(l,y,s,v,n,i)}function nt(t,i){for(var e=n.cx(),o=/\s@typedef\s+(.*)/g,u,r,f;u=o.exec(t);)r=a(i,u[1]),f=r&&u[1].slice(r.end).match(/^\s*(\S+)/),f&&(e.parent.jsdocTypedefs[f[1]]=r.type)}function s(t,i){var r=n.cx().parent._docComment.weight;t.type.propagate(i,r||(t.madeUp?v:undefined))}function tt(n,t,i,r,u,f){var e,c,o,l,h;if(u.type=="VariableDeclaration"?(c=u.declarations[0],c.init&&c.init.type=="FunctionExpression"&&(e=c.init.body.scope.fnType)):u.type=="FunctionDeclaration"?e=u.body.scope.fnType:u.type=="AssignmentExpression"?u.right.type=="FunctionExpression"&&(e=u.right.body.scope.fnType):u.type=="CallExpression"||u.value.type=="FunctionExpression"&&(e=u.value.body.scope.fnType),e&&(i||r||t)){if(i)for(o=0;o<e.argNames.length;++o)l=e.argNames[o],h=i[l],!h&&(h=i[l+"?"])&&(e.argNames[o]+="?"),h&&s(h,e.args[o]);r&&s(r,e.retval);t&&s(t,e.self)}else n&&s(n,f)}var v=1,y=101;t.registerPlugin("doc_comment",function(n,t){n.jsdocTypedefs=Object.create(null);n.on("reset",function(){n.jsdocTypedefs=Object.create(null)});return n._docComment={weight:t&&t.strong?y:undefined,fullDocs:t&&t.fullDocs},{passes:{postParse:p,postInfer:w,postLoadDef:b}}})});