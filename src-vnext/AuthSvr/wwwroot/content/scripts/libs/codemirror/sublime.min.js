(function(n){typeof exports=="object"&&typeof module=="object"?n(require("../lib/codemirror"),require("../addon/search/searchcursor"),require("../addon/edit/matchbrackets")):typeof define=="function"&&define.amd?define(["../lib/codemirror","../addon/search/searchcursor","../addon/edit/matchbrackets"],n):n(CodeMirror)})(function(n){"use strict";function b(t,i,r){var h,c,o,s,f;if(r<0&&i.ch==0)return t.clipPos(u(i.line-1));if(h=t.getLine(i.line),r>0&&i.ch>=h.length)return t.clipPos(u(i.line+1,0));c="start";for(var e=i.ch,l=r<0?0:h.length,a=0;e!=l;e+=r,a++)if(s=h.charAt(r<0?e-1:e),f=s!="_"&&n.isWordChar(s)?"w":"o",f=="w"&&s.toUpperCase()==s&&(f="W"),c=="start")f!="o"&&(c="in",o=f);else if(c=="in"&&o!=f){if(o=="w"&&f=="W"&&r<0&&e--,o=="W"&&f=="w"&&r>0){o="w";continue}break}return u(i.line,e)}function c(n,t){n.extendSelectionsBy(function(i){return n.display.shift||n.doc.extend||i.empty()?b(n.doc,i.head,t):t<0?i.from():i.to()})}function l(n,t){n.operation(function(){for(var r,i,s=n.listSelections().length,e=[],o=-1,f=0;f<s;f++)(r=n.listSelections()[f].head,r.line<=o)||(i=u(r.line+(t?0:1),0),n.replaceRange("\n",i,null,"+insertLine"),n.indentLine(i.line,null,!0),e.push({head:i,anchor:i}),o=r.line+1);n.setSelections(e)})}function e(t,i){for(var r=i.ch,f=r,e=t.getLine(i.line);r&&n.isWordChar(e.charAt(r-1));)--r;while(f<e.length&&n.isWordChar(e.charAt(f)))++f;return{from:u(i.line,r),to:u(i.line,f),word:e.slice(r,f)}}function a(n){var r=n.getCursor(),i=n.scanForBracket(r,-1),t;if(i)for(;;){if(t=n.scanForBracket(r,1),!t)return;if(t.ch==o.charAt(o.indexOf(i.ch)+1))return n.setSelection(u(i.pos.line,i.pos.ch+1),t.pos,!1),!0;r=u(t.pos.line,t.pos.ch+1)}}function v(n,t){for(var f,h,o,e=n.listSelections(),i=[],s,r=0;r<e.length;r++)if(f=e[r],!f.empty()){for(h=f.from().line,o=f.to().line;r<e.length-1&&e[r+1].from().line==o;)o=f[++r].to().line;i.push(h,o)}i.length?s=!0:i.push(n.firstLine(),n.lastLine());n.operation(function(){for(var h=[],r=0;r<i.length;r+=2){var c=i[r],l=i[r+1],f=u(c,0),e=u(l),o=n.getRange(f,e,!1);t?o.sort():o.sort(function(n,t){var i=n.toUpperCase(),r=t.toUpperCase();return i!=r&&(n=i,t=r),n<t?-1:n==t?0:1});n.replaceRange(o,f,e);s&&h.push({anchor:f,head:e})}s&&n.setSelections(h,0)})}function y(t,i){t.operation(function(){for(var c,u,f,o=t.listSelections(),s=[],h=[],r=0;r<o.length;r++)u=o[r],u.empty()?(s.push(r),h.push("")):h.push(i(t.getRange(u.from(),u.to())));for(t.replaceSelections(h,"around","case"),r=s.length-1;r>=0;r--)(u=o[s[r]],c&&n.cmpPos(u.head,c)>0)||(f=e(t,u.head),c=f.from,t.replaceRange(i(f.word),f.from,f.to))})}function p(t){var i=t.getCursor("from"),u=t.getCursor("to"),r;if(n.cmpPos(i,u)==0){if(r=e(t,i),!r.word)return;i=r.from;u=r.to}return{from:i,to:u,query:t.getRange(i,u),word:r}}function w(n,t){var r=p(n),f,i;r&&(f=r.query,i=n.getSearchCursor(f,t?r.to:r.from),(t?i.findNext():i.findPrevious())?n.setSelection(i.from(),i.to()):(i=n.getSearchCursor(f,t?u(n.firstLine(),0):n.clipPos(u(n.lastLine()))),(t?i.findNext():i.findPrevious())?n.setSelection(i.from(),i.to()):r.word&&n.setSelection(r.from,r.to)))}var t=n.keyMap.sublime={fallthrough:"default"},i=n.commands,u=n.Pos,h=n.keyMap["default"]==n.keyMap.macDefault,r=h?"Cmd-":"Ctrl-",o,s,f;i[t["Alt-Left"]="goSubwordLeft"]=function(n){c(n,-1)};i[t["Alt-Right"]="goSubwordRight"]=function(n){c(n,1)};i[t[r+"Up"]="scrollLineUp"]=function(n){var t=n.getScrollInfo(),i;n.somethingSelected()||(i=n.lineAtHeight(t.top+t.clientHeight,"local"),n.getCursor().line>=i&&n.execCommand("goLineUp"));n.scrollTo(null,t.top-n.defaultTextHeight())};i[t[r+"Down"]="scrollLineDown"]=function(n){var t=n.getScrollInfo(),i;n.somethingSelected()||(i=n.lineAtHeight(t.top,"local")+1,n.getCursor().line<=i&&n.execCommand("goLineDown"));n.scrollTo(null,t.top+n.defaultTextHeight())};i[t["Shift-"+r+"L"]="splitSelectionByLine"]=function(n){for(var r,i,t,e=n.listSelections(),o=[],f=0;f<e.length;f++)for(r=e[f].from(),i=e[f].to(),t=r.line;t<=i.line;++t)i.line>r.line&&t==i.line&&i.ch==0||o.push({anchor:t==r.line?r:u(t,0),head:t==i.line?i:u(t)});n.setSelections(o,0)};t["Shift-Tab"]="indentLess";i[t.Esc="singleSelectionTop"]=function(n){var t=n.listSelections()[0];n.setSelection(t.anchor,t.head,{scroll:!1})};i[t[r+"L"]="selectLine"]=function(n){for(var i,r=n.listSelections(),f=[],t=0;t<r.length;t++)i=r[t],f.push({anchor:u(i.from().line,0),head:u(i.to().line+1,0)});n.setSelections(f)};t["Shift-"+r+"K"]="deleteLine";i[t[r+"Enter"]="insertLineAfter"]=function(n){l(n,!1)};i[t["Shift-"+r+"Enter"]="insertLineBefore"]=function(n){l(n,!0)};i[t[r+"D"]="selectNextOccurrence"]=function(t){var f=t.getCursor("from"),o=t.getCursor("to"),s=t.state.sublimeFindFullWord==t.doc.sel,r;if(n.cmpPos(f,o)==0){if(r=e(t,f),!r.word)return;t.setSelection(r.from,r.to);s=!0}else{var h=t.getRange(f,o),c=s?new RegExp("\\b"+h+"\\b"):h,i=t.getSearchCursor(c,o);i.findNext()?t.addSelection(i.from(),i.to()):(i=t.getSearchCursor(c,u(t.firstLine(),0)),i.findNext()&&t.addSelection(i.from(),i.to()))}s&&(t.state.sublimeFindFullWord=t.doc.sel)};o="(){}[]";i[t["Shift-"+r+"Space"]="selectScope"]=function(n){a(n)||n.execCommand("selectAll")};i[t["Shift-"+r+"M"]="selectBetweenBrackets"]=function(t){if(!a(t))return n.Pass};i[t[r+"M"]="goToBracket"]=function(t){t.extendSelectionsBy(function(i){var f=t.scanForBracket(i.head,1),r;return f&&n.cmpPos(f.pos,i.head)!=0?f.pos:(r=t.scanForBracket(i.head,-1),r&&u(r.pos.line,r.pos.ch+1)||i.head)})};s=h?"Cmd-Ctrl-":"Shift-Ctrl-";i[t[s+"Up"]="swapLineUp"]=function(n){for(var e=n.listSelections(),i=[],o=n.firstLine()-1,s=[],f=0;f<e.length;f++){var t=e[f],h=t.from().line-1,r=t.to().line;s.push({anchor:u(t.anchor.line-1,t.anchor.ch),head:u(t.head.line-1,t.head.ch)});t.to().ch!=0||t.empty()||--r;h>o?i.push(h,r):i.length&&(i[i.length-1]=r);o=r}n.operation(function(){for(var t=0;t<i.length;t+=2){var r=i[t],f=i[t+1],e=n.getLine(r);n.replaceRange("",u(r,0),u(r+1,0),"+swapLine");f>n.lastLine()?n.replaceRange("\n"+e,u(n.lastLine()),null,"+swapLine"):n.replaceRange(e+"\n",u(f,0),null,"+swapLine")}n.setSelections(s);n.scrollIntoView()})};i[t[s+"Down"]="swapLineDown"]=function(n){for(var o=n.listSelections(),t=[],s=n.lastLine()+1,r=o.length-1;r>=0;r--){var i=o[r],f=i.to().line+1,e=i.from().line;i.to().ch!=0||i.empty()||f--;f<s?t.push(f,e):t.length&&(t[t.length-1]=e);s=e}n.operation(function(){for(var r=t.length-2;r>=0;r-=2){var i=t[r],f=t[r+1],e=n.getLine(i);i==n.lastLine()?n.replaceRange("",u(i-1),u(i),"+swapLine"):n.replaceRange("",u(i,0),u(i+1,0),"+swapLine");n.replaceRange(e+"\n",u(f,0),null,"+swapLine")}n.scrollIntoView()})};t[r+"/"]="toggleComment";i[t[r+"J"]="joinLines"]=function(n){for(var i=n.listSelections(),r=[],t=0;t<i.length;t++){for(var f=i[t],o=f.from(),s=o.line,e=f.to().line;t<i.length-1&&i[t+1].from().line==e;)e=i[++t].to().line;r.push({start:s,end:e,anchor:!f.empty()&&o})}n.operation(function(){for(var t,c,s,f,i,e=0,h=[],o=0;o<r.length;o++){for(t=r[o],c=t.anchor&&u(t.anchor.line-e,t.anchor.ch),f=t.start;f<=t.end;f++)i=f-e,f==t.end&&(s=u(i,n.getLine(i).length+1)),i<n.lastLine()&&(n.replaceRange(" ",u(i),u(i+1,/^\s*/.exec(n.getLine(i+1))[0].length)),++e);h.push({anchor:c||s,head:s})}n.setSelections(h,0)})};i[t["Shift-"+r+"D"]="duplicateLine"]=function(n){n.operation(function(){for(var t,r=n.listSelections().length,i=0;i<r;i++)t=n.listSelections()[i],t.empty()?n.replaceRange(n.getLine(t.head.line)+"\n",u(t.head.line,0)):n.replaceRange(n.getRange(t.from(),t.to()),t.from());n.scrollIntoView()})};i[t["Shift-"+r+"B"]="autoFormatSelection"]=function(n){n.operation(function(){var t=n.getValue(),i;if(t!==""){i=n.getMode().name;switch(i){case"javascript":n.setValue(js_beautify(t));break;case"css":n.setValue(css_beautify(t));break;default:n.setValue(html_beautify(t))}}})};t[r+"T"]="transposeChars";i[t.F9="sortLines"]=function(n){v(n,!0)};i[t[r+"F9"]="sortLinesInsensitive"]=function(n){v(n,!1)};i[t.F2="nextBookmark"]=function(n){var t=n.state.sublimeBookmarks,r,i;if(t)while(t.length)if(r=t.shift(),i=r.find(),i)return t.push(r),n.setSelection(i.from,i.to)};i[t["Shift-F2"]="prevBookmark"]=function(n){var t=n.state.sublimeBookmarks,i;if(t)while(t.length){if(t.unshift(t.pop()),i=t[t.length-1].find(),i)return n.setSelection(i.from,i.to);t.pop()}};i[t[r+"F2"]="toggleBookmark"]=function(n){for(var t,r,e=n.listSelections(),u=n.state.sublimeBookmarks||(n.state.sublimeBookmarks=[]),f=0;f<e.length;f++){var o=e[f].from(),s=e[f].to(),i=n.findMarks(o,s);for(t=0;t<i.length;t++)if(i[t].sublimeBookmark){for(i[t].clear(),r=0;r<u.length;r++)u[r]==i[t]&&u.splice(r--,1);break}t==i.length&&u.push(n.markText(o,s,{sublimeBookmark:!0,clearWhenEmpty:!1}))}};i[t["Shift-"+r+"F2"]="clearBookmarks"]=function(n){var t=n.state.sublimeBookmarks,i;if(t)for(i=0;i<t.length;i++)t[i].clear();t.length=0};i[t["Alt-F2"]="selectBookmarks"]=function(n){var i=n.state.sublimeBookmarks,u=[],t,r;if(i)for(t=0;t<i.length;t++)r=i[t].find(),r?u.push({anchor:r.from,head:r.to}):i.splice(t--,0);u.length&&n.setSelections(u,0)};t["Alt-Q"]="wrapLines";f=r+"K ";t[f+r+"Backspace"]="delLineLeft";i[t.Backspace="smartBackspace"]=function(t){if(t.somethingSelected())return n.Pass;var i=t.getCursor(),r=t.getRange({line:i.line,ch:0},i),u=n.countColumn(r,null,t.getOption("tabSize"));return/\S/.test(r)||u%t.getOption("indentUnit")!=0?n.Pass:t.indentSelection("subtract")};i[t[f+r+"K"]="delLineRight"]=function(n){n.operation(function(){for(var i=n.listSelections(),t=i.length-1;t>=0;t--)n.replaceRange("",i[t].anchor,u(i[t].to().line),"+delete");n.scrollIntoView()})};i[t[f+r+"U"]="upcaseAtCursor"]=function(n){y(n,function(n){return n.toUpperCase()})};i[t[f+r+"L"]="downcaseAtCursor"]=function(n){y(n,function(n){return n.toLowerCase()})};i[t[f+r+"Space"]="setSublimeMark"]=function(n){n.state.sublimeMark&&n.state.sublimeMark.clear();n.state.sublimeMark=n.setBookmark(n.getCursor())};i[t[f+r+"A"]="selectToSublimeMark"]=function(n){var t=n.state.sublimeMark&&n.state.sublimeMark.find();t&&n.setSelection(n.getCursor(),t)};i[t[f+r+"W"]="deleteToSublimeMark"]=function(t){var u=t.state.sublimeMark&&t.state.sublimeMark.find(),i,r,f;u&&(i=t.getCursor(),r=u,n.cmpPos(i,r)>0&&(f=r,r=i,i=f),t.state.sublimeKilled=t.getRange(i,r),t.replaceRange("",i,r))};i[t[f+r+"X"]="swapWithSublimeMark"]=function(n){var t=n.state.sublimeMark&&n.state.sublimeMark.find();t&&(n.state.sublimeMark.clear(),n.state.sublimeMark=n.setBookmark(n.getCursor()),n.setCursor(t))};i[t[f+r+"Y"]="sublimeYank"]=function(n){n.state.sublimeKilled!=null&&n.replaceSelection(n.state.sublimeKilled,null,"paste")};t[f+r+"G"]="clearBookmarks";i[t[f+r+"C"]="showInCenter"]=function(n){var t=n.cursorCoords(null,"local");n.scrollTo(null,(t.top+t.bottom)/2-n.getScrollInfo().clientHeight/2)};i[t["Shift-Alt-Up"]="selectLinesUpward"]=function(n){n.operation(function(){for(var t,r=n.listSelections(),i=0;i<r.length;i++)t=r[i],t.head.line>n.firstLine()&&n.addSelection(u(t.head.line-1,t.head.ch))})};i[t["Shift-Alt-Down"]="selectLinesDownward"]=function(n){n.operation(function(){for(var t,r=n.listSelections(),i=0;i<r.length;i++)t=r[i],t.head.line<n.lastLine()&&n.addSelection(u(t.head.line+1,t.head.ch))})};i[t[r+"F3"]="findUnder"]=function(n){w(n,!0)};i[t["Shift-"+r+"F3"]="findUnderPrevious"]=function(n){w(n,!1)};i[t["Alt-F3"]="findAllUnder"]=function(n){var i=p(n);if(i){for(var t=n.getSearchCursor(i.query),r=[],u=-1;t.findNext();)r.push({anchor:t.from(),head:t.to()}),t.from().line<=i.from.line&&t.from().ch<=i.from.ch&&u++;n.setSelections(r,u)}};t["Shift-"+r+"["]="fold";t["Shift-"+r+"]"]="unfold";t[f+r+"0"]=t[f+r+"j"]="unfoldAll";t[r+"I"]="findIncremental";t["Shift-"+r+"I"]="findIncrementalReverse";t[r+"H"]="replace";t.F3="findNext";t["Shift-F3"]="findPrev";n.normalizeKeyMap(t)});