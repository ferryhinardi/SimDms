(function(n,t){if(typeof exports=="object"&&typeof module=="object")return t(exports,require("./infer"),require("./signal"),require("acorn/acorn"),require("acorn/util/walk"));if(typeof define=="function"&&define.amd)return define(["exports","./infer","./signal","acorn/acorn","acorn/util/walk"],t);t(n.tern||(n.tern={}),tern,tern.signal,acorn,acorn.walk)})(this,function(n,t,i,r,u){"use strict";function rt(n,t){this.name=n;this.parent=t;this.scope=this.text=this.ast=this.lineOffsets=null}function s(n,i,r){n.text=r.options.stripCRs?i.replace(/\r\n/g,"\n"):i;t.withContext(r.cx,function(){n.ast=t.parse(n.text,r.passes,{directSourceFile:n,allowReturnOutsideFunction:!0})});n.lineOffsets=null}function wt(n,i,r){var u,e,h,f,o,s;if(i.query&&!v.hasOwnProperty(i.query.type))return r("No query type '"+i.query.type+"' defined");for(u=i.query,u||r(null,{}),e=i.files||[],e.length&&++n.uses,h=0;h<e.length;++h)f=e[h],f.type=="delete"?n.delFile(f.name):b(n,f.name,null,f.type=="full"?f.text:null);if(o=typeof i.timeout=="number"?[i.timeout]:null,!u){c(n,o,function(){});return}if(s=v[u.type],s.takesFile){if(typeof u.file!="string")return r(".query.file must be a string");/^#/.test(u.file)||b(n,u.file,null)}c(n,o,function(i){function h(){var i;try{i=s.run(n,u,f)}catch(t){return n.options.debug&&t.name!="TernError"&&console.error(t.stack),r(t)}r(null,i)}if(i)return r(i);var f=s.takesFile&&gt(n,e,u.file);if(s.fullFile&&f.type=="part")return r("Can't run a "+u.type+" query on a file fragment");t.withContext(n.cx,o?function(){t.withTimeout(o[0],h)}:h)})}function ft(n,i){return t.withContext(n.cx,function(){i.scope=n.cx.topScope;n.signal("beforeLoad",i);t.analyze(i.ast,i.name,i.scope,n.passes);n.signal("afterLoad",i)}),i}function b(n,t,i,r){var u=n.findFile(t),f;if(u){r!=null&&(u.scope&&(n.needsPurge.push(t),u.scope=null),s(u,r,n));y(n,u.parent)>y(n,i)&&(u.parent=i,u.excluded&&(u.excluded=null));return}f=new rt(t,i);n.files.push(f);n.fileMap[t]=f;r!=null?s(f,r,n):n.options.async?(n.startAsyncAction(),n.options.getFile(t,function(t,i){s(f,i||"",n);n.finishAsyncAction(t)})):s(f,n.options.getFile(t)||"",n)}function bt(n,t){var i=!0,r=!1;n.files.forEach(function(u){if(u.text==null)if(n.options.async)i=!1,n.options.getFile(u.name,function(i,f){if(i&&!r)return r=!0,t(i);s(u,f||"",n);bt(n,t)});else try{s(u,n.options.getFile(u.name)||"",n)}catch(f){return t(f)}});i&&t()}function et(n,t,i){var r=function(){n.off("everythingFetched",r);clearTimeout(u);c(n,t,i)},u;n.on("everythingFetched",r);u=setTimeout(r,n.options.fetchTimeout)}function c(n,i,r){var s,h,f,e,o,u,c;if(n.pending)return et(n,i,r);if(s=n.fetchError,s)return n.fetchError=null,r(s);for(n.needsPurge.length>0&&t.withContext(n.cx,function(){t.purge(n.needsPurge);n.needsPurge.length=0}),h=!0,f=0;f<n.files.length;){for(e=[];f<n.files.length;++f)u=n.files[f],u.text==null?h=!1:u.scope!=null||u.excluded||e.push(u);for(e.sort(function(t,i){return y(n,t.parent)-y(n,i.parent)}),o=0;o<e.length;o++)u=e[o],u.parent&&!ii(n,u)?u.excluded=!0:i?(c=+new Date,t.withTimeout(i[0],function(){ft(n,u)}),i[0]-=+new Date-c):ft(n,u)}h?r():et(n,i,r)}function kt(n){var t=n.indexOf("\n");return t<0?n:n.slice(0,t)}function dt(n,t,i){var f=Math.max(0,i-500),u=null,r;if(!/^\s*$/.test(n))for(;;){if(r=t.indexOf(n,f),r<0||r>i+500)break;(u==null||Math.abs(u-i)>Math.abs(r-i))&&(u=r);f=r+n.length}return u}function ot(n){for(var t=0;n;++t,n=n.prev);return t}function f(n){var t=new Error(n);return t.name="TernError",t}function gt(n,i,r){var p=r.match(/^#(\d+)$/),e,s,c;if(!p)return n.findFile(r);if(e=i[p[1]],!e||e.type=="delete")throw f("Reference to unknown file "+r);if(e.type=="full")return n.findFile(e.name);s=e.backing=n.findFile(e.name);c=e.offset;e.offsetLines&&(c={line:e.offsetLines,ch:0});e.offset=c=o(s,e.offsetLines==null?e.offset:{line:e.offsetLines,ch:0},!0);var a=kt(e.text),v=dt(a,s.text,c),h=v==null?Math.max(0,s.text.lastIndexOf("\n",c)):v,l,y;return t.withContext(n.cx,function(){var o,c,p,d,g,b,tt,k,r,f,i,it;if(t.purge(e.name,h,h+e.text.length),o=e.text,(c=o.match(/(?:"([^"]*)"|([\w$]+))\s*:\s*function\b/))&&(p=u.findNodeAround(e.backing.ast,h,"ObjectExpression"),p&&p.node.objType&&(l={type:p.node.objType,prop:c[2]||c[1]})),v&&(c=a.match(/^(.*?)\bfunction\b/))){for(d=c[1].length,g="",i=0;i<d;++i)g+=" ";o=g+o.slice(d);y=!0}var w=t.scopeAt(s.ast,h,s.scope),nt=t.scopeAt(s.ast,h+o.length,s.scope),rt=e.scope=ot(w)<ot(nt)?nt:w;e.ast=t.parse(o,n.passes,{directSourceFile:e,allowReturnOutsideFunction:!0});t.analyze(e.ast,e.name,rt,n.passes);n:if(l||y){if(b=t.scopeAt(e.ast,a.length,w),!b.fnType)break n;if(l)tt=l.type.getProp(l.prop),tt.addType(b.fnType);else if(y){if(k=t.scopeAt(s.ast,h+a.length,s.scope),k==w||!k.fnType)break n;if(r=k.fnType,f=b.fnType,!f||f.name!=r.name&&r.name)break n;for(i=0,it=Math.min(r.args.length,f.args.length);i<it;++i)r.args[i].propagate(f.args[i]);r.self.propagate(f.self);f.retval.propagate(r.retval)}}}),e}function ni(n){var t=0;return u.simple(n,{Expression:function(){++t}}),t}function y(n,t){for(var i=0;t;)t=n.findFile(t).parent,++i;return i}function ti(n,t){for(;;){var i=n.findFile(t.parent);if(!i.parent)break;t=i}return t.name}function ii(n,t){var r=ti(n,t),u=ni(t.ast),i=n.budgets[r];return(i==null&&(i=n.budgets[r]=n.options.dependencyBudget),i<u)?!1:(n.budgets[r]=i-u,!0)}function k(n){return typeof n=="number"||typeof n=="object"&&typeof n.line=="number"&&typeof n.ch=="number"}function ri(n){var i,t;if(n.query){if(typeof n.query.type!="string")return".query.type must be a string";if(n.query.start&&!k(n.query.start))return".query.start must be a position";if(n.query.end&&!k(n.query.end))return".query.end must be a position"}if(n.files){if(!Array.isArray(n.files))return"Files property must be an array";for(i=0;i<n.files.length;++i){if(t=n.files[i],typeof t!="object")return".files[n] must be objects";if(typeof t.name!="string")return".files[n].name must be a string";if(t.type=="delete")continue;else{if(typeof t.text!="string")return".files[n].text must be a string";if(t.type=="part"){if(!k(t.offset)&&typeof t.offsetLines!="number")return".files[n].offset must be a position"}else if(t.type!="full")return'.files[n].type must be "full" or "part"'}}}}function ui(n,t){for(var e=n.text,r=n.lineOffsets||(n.lineOffsets=[0]),i=0,u=0,f=Math.min(Math.floor(t/l),r.length-1),i=r[f],u=f*l;u<t;){if(++u,i=e.indexOf("\n",i)+1,i===0)return null;u%l==0&&r.push(i)}return i}function h(n,t){var r,o,e,u,i,f;if(!n)return{line:0,ch:0};for(r=n.lineOffsets||(n.lineOffsets=[0]),o=n.text,i=r.length-1;i>=0;--i)r[i]<=t&&(e=i*l,u=r[i]);for(;;){if(f=o.indexOf("\n",u),f>=t||f<0)break;u=f+1;++e}return{line:e,ch:t-u}}function d(n){for(var t in n)n[t]==null&&delete n[t];return n}function g(n,t,i){i!=null&&(n[t]=i)}function st(n,t){typeof n!="string"&&(n=n.name,t=t.name);var i=/^[A-Z]/.test(n),r=/^[A-Z]/.test(t);return i==r?n<t?-1:n==t?0:1:i?1:-1}function fi(n,t,i){return n.type=="Literal"&&typeof n.value=="string"&&n.start==t-1&&n.end<=i+1}function ht(n,t){for(var r,i=0;i<n.properties.length;i++)if(r=n.properties[i],r.key.start<=t&&r.key.end>=t)return r}function ei(n,i,u){function b(r,u,f,e){var c,a,o,h,s;if((i.omitObjectPrototype===!1||u!=n.cx.protos.Object||l)&&(i.filter===!1||!l||(i.caseInsensitive?r.toLowerCase():r).indexOf(l)===0)&&(!ft||!ft.props[r])){for(c=0;c<y.length;++c)if(a=y[c],(tt?a.name:a)==r)return;o=tt?{name:r}:r;y.push(o);u&&(i.types||i.docs||i.urls||i.origins)&&(h=u.props[r],t.resetGuessing(),s=h.getType(),o.guess=t.didGuess(),i.types&&(o.type=t.toString(h)),i.docs&&g(o,"doc",h.doc||s&&s.doc),i.urls&&g(o,"url",h.url||s&&s.url),i.origins&&g(o,"origin",h.origin||s&&s.origin));i.depths&&(o.depth=f);tt&&e&&e(o)}}var nt,ut,l,y,ft,tt,it,p,et,c,w,d,rt,ot,k,lt,h;if(i.end==null)throw f("missing .query.end field");if(n.passes.completion)for(nt=0;nt<n.passes.completion.length;nt++)if(ut=n.passes.completion[nt](u,i),ut)return ut;for(var s=o(u,i.end),a=s,v=u.text;s&&r.isIdentifierChar(v.charCodeAt(s-1));)--s;if(i.expandWordForward!==!1)while(a<v.length&&r.isIdentifierChar(v.charCodeAt(a)))++a;if(l=v.slice(s,a),y=[],i.caseInsensitive&&(l=l.toLowerCase()),tt=i.types||i.depths||i.docs||i.urls||i.origins,c=t.findExpressionAround(u.ast,null,s,u.scope),c&&(c.node.type=="MemberExpression"&&c.node.object.end<s?w=c:fi(c.node,s,a)?(rt=t.parentNode(c.node,u.ast),rt.type=="MemberExpression"&&rt.property==c.node&&(w={node:rt,state:c.state})):c.node.type=="ObjectExpression"&&(ot=ht(c.node,a),ot?(d=c,h=et=ot.key.name):l||/:\s*$/.test(u.text.slice(0,s))||(d=c,h=et=!0))),d)p=t.typeFromContext(u.ast,d),ft=d.node.objType;else if(w)h=w.node.property,h=h.type=="Literal"?h.value.slice(1):h.name,w.node=w.node.object,p=t.expressionType(w);else if(v.charAt(s-1)=="."){for(k=s-1;k&&(v.charAt(k-1)=="."||r.isIdentifierChar(v.charCodeAt(k-1)));)k--;lt=v.slice(k,s-1);lt&&(p=t.def.parsePath(lt,u.scope).getObjType(),h=l)}if(h!=null){if(n.cx.completingProperty=h,p&&t.forAllPropertiesOf(p,b),!y.length&&i.guess!==!1&&p&&p.guessProperties&&p.guessProperties(function(n,t,i){n!=h&&n!="✖"&&b(n,t,i)}),!y.length&&l.length>=2&&i.guess!==!1)for(h in n.cx.props)b(h,n.cx.props[h][0],0);it="memberCompletion"}else t.forAllLocalsAt(u.ast,s,u.scope,b),i.includeKeywords&&ct.forEach(function(n){b(n,null,0,function(n){n.isKeyword=!0})}),it="variableCompletion";return n.passes[it]&&n.passes[it].forEach(function(n){n(u,s,a,b)}),i.sort!==!1&&y.sort(st),n.cx.completingProperty=null,{start:e(i,u,s),end:e(i,u,a),isProperty:!!h,isObjectKey:!!et,completions:y}}function oi(n,t){var u=t.prefix,i=[];for(var r in n.cx.props)r=="<i>"||u&&r.indexOf(u)!==0||i.push(r);return t.sort!==!1&&i.sort(st),{completions:i}}function lt(n,t,i){var r=a(n,t,i);if(r)return r;throw f("No expression at the given position.");}function at(n){return!n||!(n=n.getType())||!(n instanceof t.Obj)?null:n}function nt(n,i,r,u){var e,l,a,s,h,c;if(u&&(t.resetGuessing(),e=t.expressionType(u)),n.passes.typeAt&&(l=o(r,i.end),n.passes.typeAt.forEach(function(n){e=n(r,l,u,e)})),!e)throw f("No type found at the given position.");return u.node.type=="ObjectExpression"&&i.end!=null&&(a=ht(u.node,o(r,i.end)))&&(s=a.key.name,h=at(t.typeFromContext(r.ast,u)),h&&h.hasProp(s)?e=h.hasProp(s):(c=at(e),c&&c.hasProp(s)&&(e=c.hasProp(s)))),e}function si(n,i,r){var e=a(r,i),s,u=nt(n,i,r,e),h=u,o;if(u=i.preferFunction?u.getFunctionType()||u.getType():u.getType(),e&&(e.node.type=="Identifier"?s=e.node.name:e.node.type!="MemberExpression"||e.node.computed||(s=e.node.property.name)),i.depth!=null&&typeof i.depth!="number")throw f(".query.depth must be a number");return o={guess:t.didGuess(),type:t.toString(h,i.depth),name:u&&u.name,exprName:s},u&&tt(u,o),!o.doc&&h.doc&&(o.doc=h.doc),d(o)}function hi(n,i,r){var o=a(r,i),u=nt(n,i,r,o),f={url:u.url,doc:u.doc,type:t.toString(u)},e=u.getType();return e&&tt(e,f),d(f)}function tt(n,i){i.url||(i.url=n.url);i.doc||(i.doc=n.doc);i.origin||(i.origin=n.origin);var r,u=t.cx().protos;!i.url&&!i.doc&&n.proto&&(r=n.proto.hasCtor)&&n.proto!=u.Object&&n.proto!=u.Function&&n.proto!=u.Array&&(i.url=r.url,i.doc=r.doc)}function ci(n,i,r){var v=a(r,i),o=nt(n,i,r,v),u,f,s,c,h;if(t.didGuess())return{};if(u=it(o),f={url:o.url,doc:o.doc,origin:o.origin},o.types)for(s=o.types.length-1;s>=0;--s)c=o.types[s],tt(c,f),u||(u=it(c));if(u&&u.node){var l=u.node.sourceFile||n.findFile(u.origin),y=e(i,l,u.node.start),p=e(i,l,u.node.end);f.start=y;f.end=p;f.file=u.origin;h=Math.max(0,u.node.start-50);f.contextOffset=u.node.start-h;f.context=l.text.slice(h,h+50)}else u&&(f.file=u.origin,vt(n,i,u,f));return d(f)}function yt(n,i,r,u,o){function w(n){return function(t,r){var u,l;if(o)for(u=r;u!=s;u=u.prev)if(l=u.hasProp(o),l)throw f("Renaming `"+c+"` to `"+o+"` would make a variable at line "+(h(n,t.start).line+1)+" point to the definition at line "+(h(n,l.name.start).line+1));p.push({file:n.name,start:e(i,n,t.start),end:e(i,n,t.end)})}}for(var y,p,l,a,v,c=u.node.name,s=u.state;s&&!(c in s.props);s=s.prev);if(!s)throw f("Could not find a definition for "+c+" "+!!n.cx.topScope.props.x);if(p=[],s.originNode){if(y="local",o){for(l=s.prev;l;l=l.prev)if(o in l.props)break;l&&t.findRefs(s.originNode,s,o,l,function(n){throw f("Renaming `"+c+"` to `"+o+"` would shadow the definition used at line "+(h(r,n.start).line+1));})}t.findRefs(s.originNode,s,c,s,w(r))}else for(y="global",a=0;a<n.files.length;++a)v=n.files[a],t.findRefs(v.ast,v.scope,c,s,w(v));return{refs:p,type:y,name:c}}function pt(n,i,r,u){function l(n){return function(t){h.push({file:n.name,start:e(i,n,t.start),end:e(i,n,t.end)})}}var c=t.expressionType(r).getObjType(),h,o,s;if(!c)throw f("Couldn't determine type of base object.");for(h=[],o=0;o<n.files.length;++o)s=n.files[o],t.findPropRefs(s.ast,s.scope,c,u.name,l(s));return{refs:h,name:u.name}}function li(n,t,i){var r=lt(i,t,!0),h,s,u,e;if(r&&r.node.type=="Identifier")return yt(n,t,i,r);if(r&&r.node.type=="MemberExpression"&&!r.node.computed)return h=r.node.property,r.node=r.node.object,pt(n,t,r,h);if(r&&r.node.type=="ObjectExpression")for(s=o(i,t.end),u=0;u<r.node.properties.length;++u)if(e=r.node.properties[u].key,e.start<=s&&e.end>=s)return pt(n,t,r,e);throw f("Not at a variable or property name.");}function ai(n,t,i){var u,r,o,h,e,s;if(typeof t.newName!="string")throw f(".query.newName should be a string");if(u=lt(i,t),!u||u.node.type!="Identifier")throw f("Not at a variable.");for(r=yt(n,t,i,u,t.newName),o=r.refs,delete r.refs,r.files=n.files.map(function(n){return n.name}),h=r.changes=[],e=0;e<o.length;++e)s=o[e],s.text=t.newName,h.push(s);return r}function vi(n){return{files:n.files.map(function(n){return n.name})}}var p=Object.create(null),w,v,ut,l,o,e,ct,a,it,vt;n.registerPlugin=function(n,t){p[n]=t};w=n.defaultOptions={debug:!1,async:!1,getFile:function(n,t){this.async&&t(null,null)},defs:[],plugins:{},fetchTimeout:1e3,dependencyBudget:2e4,reuseInstances:!0,stripCRs:!1};v={completions:{takesFile:!0,run:ei},properties:{run:oi},type:{takesFile:!0,run:si},documentation:{takesFile:!0,run:hi},definition:{takesFile:!0,run:ci},refs:{takesFile:!0,fullFile:!0,run:li},rename:{takesFile:!0,fullFile:!0,run:ai},files:{run:vi}};n.defineQueryType=function(n,t){v[n]=t};rt.prototype.asLineChar=function(n){return h(this,n)};ut=n.Server=function(n){var u,i,t,r;this.cx=null;this.options=n||{};for(u in w)n.hasOwnProperty(u)||(n[u]=w[u]);this.handlers=Object.create(null);this.files=[];this.fileMap=Object.create(null);this.needsPurge=[];this.budgets=Object.create(null);this.uses=0;this.pending=0;this.asyncError=null;this.passes=Object.create(null);this.defs=n.defs.slice(0);for(i in n.plugins)if(n.plugins.hasOwnProperty(i)&&i in p&&(t=p[i](this,n.plugins[i]),t&&t.defs&&(t.loadFirst?this.defs.unshift(t.defs):this.defs.push(t.defs)),t&&t.passes))for(r in t.passes)t.passes.hasOwnProperty(r)&&(this.passes[r]||(this.passes[r]=[])).push(t.passes[r]);this.reset()};ut.prototype=i.mixin({addFile:function(n,t,i){!i||i in this.fileMap||(i=null);b(this,n,i,t)},delFile:function(n){var t=this.findFile(n);t&&(this.needsPurge.push(t.name),this.files.splice(this.files.indexOf(t),1),delete this.fileMap[n])},reset:function(){var n,i;for(this.signal("reset"),this.cx=new t.Context(this.defs,this),this.uses=0,this.budgets=Object.create(null),n=0;n<this.files.length;++n)i=this.files[n],i.scope=null},request:function(n,t){var r=ri(n),i;if(r)return t(r);i=this;wt(this,n,function(n,r){t(n,r);i.uses>40&&(i.reset(),c(i,null,function(){}))})},findFile:function(n){return this.fileMap[n]},flush:function(n){var i=this.cx;c(this,null,function(r){if(r)return n(r);t.withContext(i,n)})},startAsyncAction:function(){++this.pending},finishAsyncAction:function(n){n&&(this.asyncError=n);--this.pending==0&&this.signal("everythingFetched")}});l=25;o=n.resolvePos=function(n,t,i){if(typeof t!="number"){var r=ui(n,t.line);if(r==null)if(i)t=n.text.length;else throw f("File doesn't contain a line "+t.line);else t=r+t.ch}if(t>n.text.length)if(i)t=n.text.length;else throw f("Position "+t+" is outside of file.");return t};e=n.outputPos=function(n,t,i){if(n.lineCharPositions){var r=h(t,i);return t.type=="part"&&(r.line+=t.offsetLines!=null?t.offsetLines:h(t.backing,t.offset).line),r}return i+(t.type=="part"?t.offset:0)};ct="break do instanceof typeof case else new var catch finally return void continue for switch while debugger function this with default if throw delete in try".split(" ");a=n.findQueryExpr=function(n,i,r){var h;if(i.end==null)throw f("missing .query.end field");if(i.variable)return h=t.scopeAt(n.ast,o(n,i.end),n.scope),{node:{type:"Identifier",name:i.variable,start:i.end,end:i.end+1},state:h};var e=i.start&&o(n,i.start),s=o(n,i.end),u=t.findExpressionAt(n.ast,e,s,n.scope);return u?u:(u=t.findExpressionAround(n.ast,e,s,n.scope),u&&(u.node.type=="ObjectExpression"||r||(e==null?s:e)-u.node.start<20||u.node.end-s<20))?u:null};it=n.getSpan=function(n){if(n.origin){if(n.originNode){var t=n.originNode;return/^Function/.test(t.type)&&t.id&&(t=t.id),{origin:n.origin,node:t}}if(n.span)return{origin:n.origin,span:n.span}}};vt=n.storeSpan=function(n,t,i,r){var u,f;r.origin=i.origin;i.span?(u=/^(\d+)\[(\d+):(\d+)\]-(\d+)\[(\d+):(\d+)\]$/.exec(i.span),r.start=t.lineCharPositions?{line:Number(u[2]),ch:Number(u[3])}:Number(u[1]),r.end=t.lineCharPositions?{line:Number(u[5]),ch:Number(u[6])}:Number(u[4])):(f=n.findFile(i.origin),r.start=e(t,f,i.node.start),r.end=e(t,f,i.node.end))};n.version="0.9.1"});