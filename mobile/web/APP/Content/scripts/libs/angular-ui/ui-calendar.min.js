angular.module("ui.calendar",[]).constant("uiCalendarConfig",{calendars:{}}).controller("uiCalendarCtrl",["$scope","$timeout","$locale",function(n,t,i){var u=1,f=1,r=n.eventSources,e=n.calendarWatchEvent?n.calendarWatchEvent:angular.noop,o=function(n){var i;return n&&(i=function(){var i=arguments,r=this;t(function(){n.apply(r,i)})}),i};this.eventsFingerprint=function(n){return n._id||(n._id=f++),""+n._id+(n.id||"")+(n.title||"")+(n.url||"")+(+n.start||"")+(+n.end||"")+(n.allDay||"")+(n.className||"")+e(n)||""};this.sourcesFingerprint=function(n){return n.__id||(n.__id=u++)};this.allEvents=function(){for(var n,e,t,i,u=[],f=0,o=r.length;f<o;f++)if(n=r[f],angular.isArray(n))u.push(n);else if(angular.isObject(n)&&angular.isArray(n.events)){e={};for(t in n)t!=="_uiCalId"&&t!=="events"&&(e[t]=n[t]);for(i=0;i<n.events.length;i++)angular.extend(n.events[i],e);u.push(n.events)}return Array.prototype.concat.apply([],u)};this.changeWatcher=function(n,t){var i,f=function(){for(var e=angular.isFunction(n)?n():n,o=[],i,u,f=0,s=e.length;f<s;f++)u=e[f],i=t(u),r[i]=u,o.push(i);return o},u=function(n,t){for(var u=[],f={},i=0,r=t.length;i<r;i++)f[t[i]]=!0;for(i=0,r=n.length;i<r;i++)f[n[i]]||u.push(n[i]);return u},r={},e=function(n,f){for(var o,c,v={},y=u(f,n),s,l,a,e=0,h=y.length;e<h;e++)if(s=y[e],o=r[s],delete r[s],l=t(o),l===s)i.onRemoved(o);else{v[l]=s;i.onChanged(o)}for(a=u(n,f),e=0,h=a.length;e<h;e++)if(c=a[e],o=r[c],!v[c])i.onAdded(o)};return i={subscribe:function(n,t){n.$watch(f,function(n,i){t&&t(n,i)===!1||e(n,i)},!0)},onAdded:angular.noop,onChanged:angular.noop,onRemoved:angular.noop}};this.getFullCalendarConfig=function(n,t){var i={};return angular.extend(i,t),angular.extend(i,n),angular.forEach(i,function(n,t){typeof n=="function"&&(i[t]=o(i[t]))}),i};this.getLocaleConfig=function(n){if(!n.lang||n.useNgLocale){var t=function(n){var t,i;t=[];for(i in n)t[i]=n[i];return t},r=i.DATETIME_FORMATS;return{monthNames:t(r.MONTH),monthNamesShort:t(r.SHORTMONTH),dayNames:t(r.DAY),dayNamesShort:t(r.SHORTDAY)}}return{}}}]).directive("uiCalendar",["uiCalendarConfig",function(n){return{restrict:"A",scope:{eventSources:"=ngModel",calendarWatchEvent:"&"},controller:"uiCalendarCtrl",link:function(t,i,r,u){function l(){var h=r.uiCalendar?t.$parent.$eval(r.uiCalendar):{},f,o,s,i;f=u.getFullCalendarConfig(h,n);o=u.getLocaleConfig(f);angular.extend(o,f);e={eventSources:c};angular.extend(e,o);e.calendars=null;s={};for(i in e)i!=="eventSources"&&(s[i]=e[i]);return JSON.stringify(s)}var c=t.eventSources,o=!1,f,h=u.changeWatcher(c,u.sourcesFingerprint),s=u.changeWatcher(u.allEvents,u.eventsFingerprint),e=null;t.destroy=function(){f&&f.fullCalendar&&f.fullCalendar("destroy");f=r.calendar?n.calendars[r.calendar]=$(i).html(""):$(i).html("")};t.init=function(){f.fullCalendar(e)};h.onAdded=function(n){f.fullCalendar("addEventSource",n);o=!0};h.onRemoved=function(n){f.fullCalendar("removeEventSource",n);o=!0};s.onAdded=function(n){f.fullCalendar("renderEvent",n)};s.onRemoved=function(n){f.fullCalendar("removeEvents",function(t){return t._id===n._id})};s.onChanged=function(n){n._start=$.fullCalendar.moment(n.start);n._end=$.fullCalendar.moment(n.end);f.fullCalendar("updateEvent",n)};h.subscribe(t);s.subscribe(t,function(){if(o===!0)return o=!1,!1});t.$watch(l,function(){t.destroy();t.init()})}}}]);