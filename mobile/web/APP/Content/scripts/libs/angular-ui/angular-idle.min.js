/*** Directives and services for responding to idle users in AngularJS
* @author Mike Grabski <me@mikegrabski.com>
* @version v1.0.4
* @link https://github.com/HackedByChinese/ng-idle.git
* @license MIT
*/
(function(n,t){"use strict";t.module("ngIdle",["ngIdle.keepalive","ngIdle.idle","ngIdle.countdown","ngIdle.title","ngIdle.localStorage"]);t.module("ngIdle.keepalive",[]).provider("Keepalive",function(){var n={http:null,interval:600},i;this.http=function(i){if(!i)throw new Error("Argument must be a string containing a URL, or an object containing the HTTP request configuration.");t.isString(i)&&(i={url:i,method:"GET"});i.cache=!1;n.http=i};i=this.interval=function(t){if(t=parseInt(t),isNaN(t)||t<=0)throw new Error("Interval must be expressed in seconds and be greater than 0.");n.interval=t};this.$get=["$rootScope","$log","$interval","$http",function(r,u,f,e){function s(n,t){r.$broadcast("KeepaliveResponse",n,t)}function h(){r.$broadcast("Keepalive");t.isObject(n.http)&&e(n.http).success(s).error(s)}var o={ping:null};return{_options:function(){return n},setInterval:i,start:function(){return f.cancel(o.ping),o.ping=f(h,n.interval*1e3),o.ping},stop:function(){f.cancel(o.ping)},ping:function(){h()}}}]});t.module("ngIdle.idle",["ngIdle.keepalive","ngIdle.localStorage"]).provider("Idle",function(){var n={idle:1200,timeout:30,autoResume:"idle",interrupt:"mousemove keydown DOMMouseScroll mousewheel mousedown touchstart touchmove scroll",keepalive:!0},r=this.timeout=function(i){if(i===!1)n.timeout=0;else if(t.isNumber(i)&&i>=0)n.timeout=i;else throw new Error("Timeout must be zero or false to disable the feature, or a positive integer (in seconds) to enable it.");},i;this.interrupt=function(t){n.interrupt=t};i=this.idle=function(t){if(t<=0)throw new Error("Idle must be a value in seconds, greater than 0.");n.idle=t};this.autoResume=function(t){n.autoResume=t===!0?"idle":t===!1?"off":t};this.keepalive=function(t){n.keepalive=t===!0};this.$get=["$interval","$log","$rootScope","$document","Keepalive","IdleLocalStorage","$window",function(u,f,e,o,s,h,c){function w(){n.keepalive&&(l.running&&s.ping(),s.start())}function a(){n.keepalive&&s.stop()}function b(){l.idling=!l.idling;var t=l.idling?"Start":"End";e.$broadcast("Idle"+t);l.idling?(a(),n.timeout&&(l.countdown=n.timeout,k(),l.timeout=u(k,1e3,n.timeout,!1))):w();u.cancel(l.idle)}function k(){if(l.countdown<=0){d();return}e.$broadcast("IdleWarn",l.countdown);l.countdown--}function d(){a();u.cancel(l.idle);u.cancel(l.timeout);l.idling=!0;l.running=!1;l.countdown=0;e.$broadcast("IdleTimeout")}function g(n,t,i){var r=n.running();n.unwatch();t(i);r&&n.watch()}function tt(){var n=h.get("expiry");return new Date(n.time)}function nt(n){n?h.set("expiry",{id:p,time:n}):h.remove("expiry")}var l={idle:null,timeout:null,idling:!1,running:!1,countdown:null},p=(new Date).getTime(),v={_options:function(){return n},_getNow:function(){return new Date},setIdle:function(n){g(this,i,n)},setTimeout:function(n){g(this,r,n)},isExpired:function(){var n=tt();return n&&n<=this._getNow()},running:function(){return l.running},idling:function(){return l.idling},watch:function(t){u.cancel(l.idle);u.cancel(l.timeout);var i=n.timeout?n.timeout:0;t||nt(new Date((new Date).getTime()+(n.idle+i)*1e3));l.idling?b():l.running||w();l.running=!0;l.idle=u(b,n.idle*1e3,0,!1)},unwatch:function(){u.cancel(l.idle);u.cancel(l.timeout);l.idling=!1;l.running=!1;nt(null);a()},interrupt:function(t){if(l.running){if(n.timeout&&this.isExpired()){d();return}n.autoResume!=="idle"&&(n.autoResume!=="notIdle"||l.idling)||this.watch(t)}}},y;o.find("body").on(n.interrupt,function(){v.interrupt()});return y=function(n){if(n.key==="ngIdle.expiry"&&n.newValue!==n.oldValue){var i=t.fromJson(n.newValue);if(i.id===p)return;v.interrupt(!0)}},c.addEventListener?c.addEventListener("storage",y,!1):c.attachEvent("onstorage",y),v}]});t.module("ngIdle.countdown",[]).directive("idleCountdown",function(){return{restrict:"A",scope:{value:"=idleCountdown"},link:function(n){n.$on("IdleWarn",function(t,i){n.$apply(function(){n.value=i})});n.$on("IdleTimeout",function(){n.$apply(function(){n.value=0})})}}});t.module("ngIdle.title",[]).factory("Title",["$document","$interpolate",function(n,i){function u(n,t,i){return Array(t-String(n).length+1).join(i||"0")+n}var r={original:null,idle:"{{minutes}}:{{seconds}} until your session times out!",timedout:"Your session has expired."};return{original:function(n){if(t.isUndefined(n))return r.original;r.original=n},store:function(n){(n||!r.original)&&(r.original=this.value())},value:function(i){if(t.isUndefined(i))return n[0].title;n[0].title=i},idleMessage:function(n){if(t.isUndefined(n))return r.idle;r.idle=n},timedOutMessage:function(n){if(t.isUndefined(n))return r.timedout;r.timedout=n},setAsIdle:function(n){this.store();var t={totalSeconds:n};t.minutes=Math.floor(n/60);t.seconds=u(n-t.minutes*60,2);this.value(i(this.idleMessage())(t))},setAsTimedOut:function(){this.store();this.value(this.timedOutMessage())},restore:function(){this.original()&&this.value(this.original())}}}]).directive("title",["Title",function(n){return{restrict:"E",link:function(t,i,r){r.idleDisabled||(n.store(!0),t.$on("IdleWarn",function(t,i){n.setAsIdle(i)}),t.$on("IdleEnd",function(){n.restore()}),t.$on("IdleTimeout",function(){n.setAsTimedOut()}))}}}]);t.module("ngIdle.localStorage",[]).service("IdleLocalStorage",["$window",function(n){var i=n.localStorage;return{set:function(n,r){i.setItem("ngIdle."+n,t.toJson(r))},get:function(n){return t.fromJson(i.getItem("ngIdle."+n))},remove:function(n){i.removeItem("ngIdle."+n)}}}])})(window,window.angular);