(function(n,t){if(typeof exports=="object"&&typeof module=="object")return t(exports,require("acorn/acorn"),require("acorn/acorn_loose"),require("acorn/util/walk"),require("./def"),require("./signal"));if(typeof define=="function"&&define.amd)return define(["exports","acorn/acorn","acorn/acorn_loose","acorn/util/walk","./def","./signal"],t);t(n.tern||(n.tern={}),acorn,acorn,acorn.walk,tern.def,tern.signal)})(this,function(n,t,i,r,u,f){"use strict";function w(n,t){var r=Object.create(n),i;if(t)for(i in t)r[i]=t[i];return r}function et(n,t,i){var r=n.getType(!1),u=t.getType(!1);return!r||!u?!0:at(r,u,i)}function at(n,t,i){var e,o,r;if(!n||i>=5)return t;if(!n||n==t||!t)return n;if(n.constructor!=t.constructor)return!1;if(n.constructor==y){if((e=n.getProp("<i>").getType(!1),!e)||(o=t.getProp("<i>").getType(!1),!o||at(e,o,i+1)))return t}else{if(n.constructor==s){var u=0,f=0,h=0;for(r in n.props)u++,r in t.props&&et(n.props[r],t.props[r],i+1)&&h++;for(r in t.props)f++;return u&&f&&h<Math.max(u,f)/2?!1:u>f?n:t}return n.constructor==a?n.args.length!=t.args.length||!n.args.every(function(n,r){return et(n,t.args[r],i+1)})||!et(n.retval,t.retval,i+1)||!et(n.self,t.self,i+1)?!1:n:!1}}function ii(n){for(var v,c,l,t,i,f,e=0,o=0,h=0,u=null,r=0;r<n.length;++r)if(t=n[r],t instanceof y)++e;else if(t instanceof a)++o;else if(t instanceof s)++h;else if(t instanceof g){if(u&&t.name!=u.name)return null;u=t}if(v=(e&&1)+(o&&1)+(h&&1)+(u&&1),v>1)return null;if(u)return u;for(c=0,l=null,r=0;r<n.length;++r){if(t=n[r],i=0,e)i=t.getProp("<i>").isEmpty()?1:2;else if(o){for(i=1,f=0;f<t.args.length;++f)t.args[f].isEmpty()||++i;t.retval.isEmpty()||++i}else h&&(i=t.name?100:2);i>=c&&(c=i,l=t)}return l}function ot(){}function rr(n,t){e.disabledComputing={fn:n,prev:e.disabledComputing};try{return t()}finally{e.disabledComputing=e.disabledComputing.prev}}function lr(n,t){var i=e.props[n]||(e.props[n]=[]);i.push(t)}function fi(n){return e.props[n]}function si(t){var f,r;if(e.workList)return t(e.workList);var i=[],u=0,o=e.workList=function(n,t,r){u<ei-oi*i.length&&i.push(n,t,r,u)};try{for(f=t(o),r=0;r<i.length;r+=4){if(rt&&+new Date>=rt)throw new n.TimedOut;u=i[r+3]+1;i[r+1].addType(i[r],i[r+2])}return f}finally{e.workList=null}}function b(n,t){n.fnType&&(n.fnType.instantiateScore=(n.fnType.instantiateScore||0)+t)}function ar(n,t){try{return r.simple(n,{Expression:function(){if(--t<=0)throw vt;}}),!0}catch(i){if(i==vt)return!1;throw i;}}function hi(n,t){var i=t.fnType.instantiateScore;if(!e.disabledComputing&&i&&t.fnType.args.length&&ar(n,i*5))return b(t.prev,i/2),vr(n,t),!0;t.fnType.instantiateScore=null}function vr(n,t){for(var i=t.fnType,u=0;u<i.args.length;++u)i.args[u]=new c;i.self=new c;i.computeRet=function(u,f){return rr(i,function(){var b=e.curOrigin,s,l,w,v,p,h;e.curOrigin=i.origin;s=new nt(t.prev);s.originNode=t.originNode;for(l in t.props)for(w=s.defProp(l,t.props[l].originNode),h=0;h<f.length;++h)i.argNames[h]==l&&h<f.length&&f[h].propagate(w);for(v=i.argNames.length!=f.length?i.argNames.slice(0,f.length):i.argNames;v.length<f.length;)v.push("?");if(s.fnType=new a(i.name,u,f,v,o),s.fnType.originNode=i.originNode,i.arguments)for(p=s.fnType.arguments=new c,s.defProp("arguments").addType(new y(p)),h=0;h<f.length;++h)f[h].propagate(p);return n.body.scope=s,r.recursive(n.body,s,null,yt),r.recursive(n.body,s,null,bt),e.curOrigin=b,s.fnType.retval})}}function ci(n){function e(n,t,i){var f,u,o,s,h;if(!(i>3)&&n.forward)for(f=0;f<n.forward.length;++f)if(u=n.forward[f].propagatesTo(),u){if(o=t,u instanceof c)s=u;else if(u.target instanceof c)o+=u.pathExt,s=u.target;else continue;if(s==r)return o;if(h=e(s,o,i+1),h)return h}}var i=n.fnType,r=i.retval,s,h,t,f,l;if(r!=o){for(!r.isEmpty()&&(s=r.getType())instanceof y&&(r=h=s.getProp("<i>")),t=e(i.self,"!this",0),f=0;!t&&f<i.args.length;++f)t=e(i.args[f],"!"+f,0);if(t)return h&&(t="["+t+"]"),l=new u.TypeParser(t),i.computeRet=l.parseRetType(),i.computeRetSource=t,!0}}function ht(n,t){return n.defProp(t.name,t)}function ct(n,t,i){var r=n.property;return n.computed?r.type=="Literal"&&typeof r.value=="string"?r.value:(i&&h(r,t,i,o),"<i>"):r.name}function pt(n){switch(n){case"+":case"-":case"~":return e.num;case"!":return e.bool;case"typeof":return e.str;case"void":case"delete":return o}}function wt(n){switch(n){case"==":case"!=":case"===":case"!==":case"<":case">":case">=":case"<=":case"in":case"instanceof":return!0}}function li(n){if(n.regex)return d(e.protos.RegExp);switch(typeof n.value){case"boolean":return e.bool;case"number":return e.num;case"string":return e.str;case"object":case"function":return n.value?d(e.protos.RegExp):o}}function p(n){return function(t,i,r,u,f){var e=n(t,i,r,f);return u&&e.propagate(u),e}}function ut(n){return function(t,i,r,u,f){return u||(u=new c),n(t,i,r,u,f),u}}function h(n,t,i,r,u){return ai[n.type](n,t,i,r,u)}function kt(n,t){var r=n&&n[t],u=Array.prototype.slice.call(arguments,2),i;if(r)for(i=0;i<r.length;++i)r[i].apply(null,u)}function yr(n,t,i){var r=Array.isArray(n);return r&&n.length==1&&(n=n[0],r=!1),r?i==null?function(t){return n.indexOf(t.origin)>-1}:function(r,u){return u&&u.start>=t&&u.end<=i&&n.indexOf(r.origin)>-1}:i==null?function(t){return t.origin==n}:function(r,u){return u&&u.start>=t&&u.end<=i&&r.origin==n}}function pr(n){var t,i,r;if(tt=!0,t=fi(n),t)for(i=0;i<t.length;++i)if(r=t[i].getProp(n),!r.isEmpty())return r;return o}function l(n,t){return lt[n.type](n,t)}var k=n.toString=function(n,t,i){return!n||n==i?"?":n.toString(t,i)},o=n.ANull=f.mixin({addType:function(){},propagate:function(){},getProp:function(){return o},forAllProps:function(){},hasType:function(){return!1},isEmpty:function(){return!0},getFunctionType:function(){},getObjType:function(){},getType:function(){},gatherProperties:function(){},propagatesTo:function(){},typeHint:function(){},propHint:function(){},toString:function(){return"?"}}),ni=100,wi=90,bi=10,ki=5,di=5,gi=90,nr=2,c=n.AVal=function(){this.types=[];this.forward=null;this.maxWeight=0},ti,g,s,a,y,e,rt,ei,oi,nt,vt,yt,ai,bt,vi,lt,ft,dt,tt,gt,yi,pi;c.prototype=w(o,{addType:function(n,t){if(t=t||ni,this.maxWeight<t){if(this.maxWeight=t,this.types.length==1&&this.types[0]==n)return;this.types.length=0}else if(this.maxWeight>t||this.types.indexOf(n)>-1)return;this.signal("addType",n);this.types.push(n);var i=this.forward;i&&si(function(r){for(var u=0;u<i.length;++u)r(n,i[u],t)})},propagate:function(n,t){if(n!=o&&!(n instanceof it)){t&&t!=ni&&(n=new cr(n,t));(this.forward||(this.forward=[])).push(n);var i=this.types;i.length&&si(function(r){for(var u=0;u<i.length;++u)r(i[u],n,t)})}},getProp:function(n){if(n=="__proto__"||n=="✖")return o;var t=(this.props||(this.props=Object.create(null)))[n];return t||(t=this.props[n]=new c,this.propagate(new tr(n,t))),t},forAllProps:function(n){this.propagate(new ir(n))},hasType:function(n){return this.types.indexOf(n)>-1},isEmpty:function(){return this.types.length===0},getFunctionType:function(){for(var n=this.types.length-1;n>=0;--n)if(this.types[n]instanceof a)return this.types[n]},getObjType:function(){for(var n,t=null,i=this.types.length-1;i>=0;--i)if(n=this.types[i],n instanceof s){if(n.name)return n;t||(t=n)}return t},getType:function(n){return this.types.length===0&&n!==!1?this.makeupType():this.types.length===1?this.types[0]:ii(this.types)},toString:function(n,t){if(this.types.length==0)return k(this.makeupType(),n,t);if(this.types.length==1)return k(this.types[0],n,t);var i=ti(this.types);return i.length>2?"?":i.map(function(i){return k(i,n,t)}).join("|")},computedPropType:function(){if(!this.propertyOf||!this.propertyOf.hasProp("<i>"))return null;var n=this.propertyOf.getProp("<i>");return n==this?null:n.getType()},makeupType:function(){var c=this.computedPropType(),r,o,u,f,s,n,i,t,h;if(c)return c;if(!this.forward)return null;for(n=this.forward.length-1;n>=0;--n)if(r=this.forward[n].typeHint(),r&&!r.isEmpty())return tt=!0,r;for(o=Object.create(null),u=null,n=0;n<this.forward.length;++n)t=this.forward[n].propHint(),t&&t!="length"&&t!="<i>"&&t!="✖"&&t!=e.completingProperty&&(o[t]=!0,u=t);if(!u)return null;if(f=fi(u),f){s=[];n:for(n=0;n<f.length;++n){i=f[n];for(t in o)if(!i.hasProp(t))continue n;i.hasCtor&&(i=d(i));s.push(i)}if(h=ii(s),h)return tt=!0,h}},typeHint:function(){return this.types.length?this.getType():null},propagatesTo:function(){return this},gatherProperties:function(n,t){for(var i=0;i<this.types.length;++i)this.types[i].gatherProperties(n,t)},guessProperties:function(n){var t,i,r;if(this.forward)for(t=0;t<this.forward.length;++t)i=this.forward[t].propHint(),i&&n(i,null,0);r=this.makeupType();r&&r.gatherProperties(n)}});ti=n.simplifyTypes=function(n){var t=[],r,u,i,f;n:for(r=0;r<n.length;++r){for(u=n[r],i=0;i<t.length;i++)if(f=at(u,t[i],0),f){t[i]=f;continue n}t.push(u)}return t};ot.prototype=w(o,{init:function(){this.origin=e.curOrigin}});var v=n.constraint=function(n,t){var f="this.init();",i,r,u;for(n=n?n.split(", "):[],i=0;i<n.length;++i)f+="this."+n[i]+" = "+n[i]+";";r=Function.apply(null,n.concat([f]));r.prototype=Object.create(ot.prototype);for(u in t)t.hasOwnProperty(u)&&(r.prototype[u]=t[u]);return r},tr=v("prop, target",{addType:function(n,t){n.getProp&&n.getProp(this.prop).propagate(this.target,t)},propHint:function(){return this.prop},propagatesTo:function(){if(this.prop=="<i>"||!/[^\w_]/.test(this.prop))return{target:this.target,pathExt:"."+this.prop}}}),ri=n.PropHasSubset=v("prop, type, originNode",{addType:function(n,t){if(n instanceof s){var i=n.defProp(this.prop,this.originNode);i.origin=this.origin;this.type.propagate(i,t)}},propHint:function(){return this.prop}}),ir=v("c",{addType:function(n){n instanceof s&&n.forAllProps(this.c)}});var st=n.IsCallee=v("self, args, argNodes, retval",{init:function(){ot.prototype.init.call(this);this.disabled=e.disabledComputing},addType:function(n,t){var i,u,r;if(n instanceof a){for(i=0;i<this.args.length;++i)i<n.args.length&&this.args[i].propagate(n.args[i],t),n.arguments&&this.args[i].propagate(n.arguments,t);if(this.self.propagate(n.self,this.self==e.topScope?gi:t),u=n.computeRet,u)for(r=this.disabled;r;r=r.prev)(r.fn==n||n.originNode&&r.fn.originNode==n.originNode)&&(u=null);u?u(this.self,this.args,this.argNodes).propagate(this.retval,t):n.retval.propagate(this.retval,t)}},typeHint:function(){for(var n=[],t=0;t<this.args.length;++t)n.push("?");return new a(null,this.self,this.args,n,o)},propagatesTo:function(){return{target:this.retval,pathExt:".!ret"}}}),ur=v("propName, args, argNodes, retval",{init:function(){ot.prototype.init.call(this);this.disabled=e.disabledComputing},addType:function(n,t){var i=new st(n,this.args,this.argNodes,this.retval);i.disabled=this.disabled;n.getProp(this.propName).propagate(i,t)},propHint:function(){return this.propName}}),fr=n.IsCtor=v("target, noReuse",{addType:function(n,t){n instanceof a&&(e.parent&&!e.parent.options.reuseInstances&&(this.noReuse=!0),n.getProp("prototype").propagate(new er(this.noReuse?!1:n,this.target),t))}}),d=n.getInstance=function(n,t){var i,u,r;if(t===!1)return new s(n);for(t||(t=n.hasCtor),n.instances||(n.instances=[]),i=0;i<n.instances.length;++i)if(u=n.instances[i],u.ctor==t)return u.instance;return r=new s(n,t&&t.name),r.origin=n.origin,n.instances.push({ctor:t,instance:r}),r},er=n.IsProto=v("ctor, target",{addType:function(n){n instanceof s&&((this.count=(this.count||0)+1)>8||(n==e.protos.Array?this.target.addType(new y):this.target.addType(d(n,this.ctor))))}}),or=v("fn",{addType:function(n){if(n instanceof s&&!n.hasCtor){n.hasCtor=this.fn;var t=new hr(n,this.fn);t.addType(this.fn);n.forAllProps(function(n,i,r){r&&i.propagate(t)})}}}),ui=v("other, target",{addType:function(n,t){n==e.str?this.target.addType(e.str,t):n==e.num&&this.other.hasType(e.num)&&this.target.addType(e.num,t)},typeHint:function(){return this.other}}),sr=n.IfObj=v("target",{addType:function(n,t){n instanceof s&&this.target.addType(n,t)},propagatesTo:function(){return this.target}}),hr=v("obj, ctor",{addType:function(n){n instanceof a&&n.self&&n.self.isEmpty()&&n.self.addType(d(this.obj,this.ctor),nr)}}),cr=v("inner, weight",{addType:function(n,t){this.inner.addType(n,Math.min(t,this.weight))},propagatesTo:function(){return this.inner.propagatesTo()},typeHint:function(){return this.inner.typeHint()},propHint:function(){return this.inner.propHint()}}),it=n.Type=function(){};it.prototype=w(o,{constructor:it,propagate:function(n,t){n.addType(this,t)},hasType:function(n){return n==this},isEmpty:function(){return!1},typeHint:function(){return this},getType:function(){return this}});g=n.Prim=function(n,t){this.name=t;this.proto=n};g.prototype=w(it.prototype,{constructor:g,toString:function(){return this.name},getProp:function(n){return this.proto.hasProp(n)||o},gatherProperties:function(n,t){this.proto&&this.proto.gatherProperties(n,t)}});s=n.Obj=function(n,t){if(this.props||(this.props=Object.create(null)),this.proto=n===!0?e.protos.Object:n,n&&!t&&n.name&&!(this instanceof a)){var i=/^(.*)\.prototype$/.exec(this.proto.name);i&&(t=i[1])}this.name=t;this.maybeProps=null;this.origin=e.curOrigin};s.prototype=w(it.prototype,{constructor:s,toString:function(n){var t,r,i;if(!n&&this.name)return this.name;t=[];r=!1;for(i in this.props)if(i!="<i>"){if(t.length>5){r=!0;break}n?t.push(i+": "+k(this.props[i],n-1)):t.push(i)}return t.sort(),r&&t.push("..."),"{"+t.join(", ")+"}"},hasProp:function(n,t){var r=this.props[n],i;if(t!==!1)for(i=this.proto;i&&!r;i=i.proto)r=i.props[n];return r},defProp:function(n,t){var r=this.hasProp(n,!1),i;return r?(t&&!r.originNode&&(r.originNode=t),r):n=="__proto__"||n=="✖"?o:(i=this.maybeProps&&this.maybeProps[n],i?(delete this.maybeProps[n],this.maybeUnregProtoPropHandler()):(i=new c,i.propertyOf=this),this.props[n]=i,i.originNode=t,i.origin=e.curOrigin,this.broadcastProp(n,i,!0),i)},getProp:function(n){var i=this.hasProp(n,!0)||this.maybeProps&&this.maybeProps[n],t;return i?i:n=="__proto__"||n=="✖"?o:(t=this.ensureMaybeProps()[n]=new c,t.propertyOf=this,t)},broadcastProp:function(n,t,i){var r,u;if(i&&(this.signal("addProp",n,t),this instanceof nt||lr(n,this)),this.onNewProp)for(r=0;r<this.onNewProp.length;++r)u=this.onNewProp[r],u.onProtoProp?u.onProtoProp(n,t,i):u(n,t,i)},onProtoProp:function(n,t){var i=this.maybeProps&&this.maybeProps[n];i&&(delete this.maybeProps[n],this.maybeUnregProtoPropHandler(),this.proto.getProp(n).propagate(i));this.broadcastProp(n,t,!1)},ensureMaybeProps:function(){return this.maybeProps||(this.proto&&this.proto.forAllProps(this),this.maybeProps=Object.create(null)),this.maybeProps},removeProp:function(n){var t=this.props[n];delete this.props[n];this.ensureMaybeProps()[n]=t;t.types.length=0},forAllProps:function(n){var t,i;for(this.onNewProp||(this.onNewProp=[],this.proto&&this.proto.forAllProps(this)),this.onNewProp.push(n),t=this;t;t=t.proto)for(i in t.props)if(n.onProtoProp)n.onProtoProp(i,t.props[i],t==this);else n(i,t.props[i],t==this)},maybeUnregProtoPropHandler:function(){if(this.maybeProps){for(var n in this.maybeProps)return;this.maybeProps=null}!this.proto||this.onNewProp&&this.onNewProp.length||this.proto.unregPropHandler(this)},unregPropHandler:function(n){for(var t=0;t<this.onNewProp.length;++t)if(this.onNewProp[t]==n){this.onNewProp.splice(t,1);break}this.maybeUnregProtoPropHandler()},gatherProperties:function(n,t){for(var i in this.props)i!="<i>"&&n(i,this,t);this.proto&&this.proto.gatherProperties(n,t+1)},getObjType:function(){return this}});a=n.Fn=function(n,t,i,r,u){s.call(this,e.protos.Function,n);this.self=t;this.args=i;this.argNames=r;this.retval=u};a.prototype=w(s.prototype,{constructor:a,toString:function(n){var t,i,r;for(n&&n--,t="fn(",i=0;i<this.args.length;++i)i&&(t+=", "),r=this.argNames[i],r&&r!="?"&&(t+=r+": "),t+=k(this.args[i],n,this);return t+=")",this.retval.isEmpty()||(t+=" -> "+k(this.retval,n,this)),t},getProp:function(n){var t,i;return n=="prototype"?(t=this.hasProp(n,!1),t||(t=this.defProp(n),i=new s(!0,this.name&&this.name+".prototype"),i.origin=this.origin,t.addType(i,bi)),t):s.prototype.getProp.call(this,n)},defProp:function(n,t){if(n=="prototype"){var i=this.hasProp(n,!1);return i?i:(i=s.prototype.defProp.call(this,n,t),i.origin=this.origin,i.propagate(new or(this)),i)}return s.prototype.defProp.call(this,n,t)},getFunctionType:function(){return this}});y=n.Arr=function(n){s.call(this,e.protos.Array);var t=this.defProp("<i>");n&&n.propagate(t)};y.prototype=w(s.prototype,{constructor:y,toString:function(n){return"["+k(this.getProp("<i>"),n,this)+"]"}});n.Context=function(t,i){this.parent=i;this.props=Object.create(null);this.protos=Object.create(null);this.origins=[];this.curOrigin="ecma5";this.paths=Object.create(null);this.definitions=Object.create(null);this.purgeGen=0;this.workList=null;this.disabledComputing=null;n.withContext(this,function(){if(e.protos.Object=new s(null,"Object.prototype"),e.topScope=new nt,e.topScope.name="<top>",e.protos.Array=new s(!0,"Array.prototype"),e.protos.Function=new s(!0,"Function.prototype"),e.protos.RegExp=new s(!0,"RegExp.prototype"),e.protos.String=new s(!0,"String.prototype"),e.protos.Number=new s(!0,"Number.prototype"),e.protos.Boolean=new s(!0,"Boolean.prototype"),e.str=new g(e.protos.String,"string"),e.bool=new g(e.protos.Boolean,"bool"),e.num=new g(e.protos.Number,"number"),e.curOrigin=null,t)for(var n=0;n<t.length;++n)u.load(t[n])})};e=null;n.cx=function(){return e};n.withContext=function(n,t){var i=e;e=n;try{return t()}finally{e=i}};n.TimedOut=function(){this.message="Timed out";this.stack=(new Error).stack};n.TimedOut.prototype=Object.create(Error.prototype);n.TimedOut.prototype.name="infer.TimedOut";n.withTimeout=function(n,t){var r=+new Date+n,i=rt;if(i&&i<r)return t();rt=r;try{return t()}finally{rt=i}};n.addOrigin=function(n){e.origins.indexOf(n)<0&&e.origins.push(n)};ei=20;oi=.0001;nt=n.Scope=function(n){s.call(this,n||!0);this.prev=n};nt.prototype=w(s.prototype,{constructor:nt,defVar:function(n,t){for(var r,i=this;;i=i.proto){if(r=i.props[n],r)return r;if(!i.prev)return i.defProp(n,t)}}});vt={};yt=r.make({Function:function(n,t,i){var r=n.body.scope=new nt(t),f,e,u,s,h;for(r.originNode=n,f=[],e=[],u=0;u<n.params.length;++u)s=n.params[u],e.push(s.name),f.push(ht(r,s));r.fnType=new a(n.id&&n.id.name,new c,f,e,o);r.fnType.originNode=n;n.id&&(h=n.type=="FunctionDeclaration",ht(h?t:r,n.id));i(n.body,r,"ScopeBody")},TryStatement:function(n,t,i){var r,u;i(n.block,t,"Statement");n.handler&&(r=ht(t,n.handler.param),i(n.handler.body,t,"ScopeBody"),u=e.definitions.ecma5,u&&r.isEmpty()&&d(u["Error.prototype"]).propagate(r,di));n.finalizer&&i(n.finalizer,t,"Statement")},VariableDeclaration:function(n,t,i){for(var u,r=0;r<n.declarations.length;++r)u=n.declarations[r],ht(t,u.id),u.init&&i(u.init,t,"Expression")}});ai={ArrayExpression:p(function(n,t,i){for(var u,f=new c,r=0;r<n.elements.length;++r)u=n.elements[r],u&&h(u,t,i,f);return new y(f)}),ObjectExpression:p(function(n,t,i,r){var e=n.objType=new s(!0,r),c,u,f,r,l,a;for(e.originNode=n,c=0;c<n.properties.length;++c)if(u=n.properties[c],f=u.key,u.value.name!="✖"){if(f.type=="Identifier"?r=f.name:typeof f.value=="string"&&(r=f.value),!r||u.kind=="set"){h(u.value,t,i,o);continue}l=e.defProp(r,f);a=l;l.initializer=!0;u.kind=="get"&&(a=new st(e,[],null,l));h(u.value,t,i,a,r)}return e}),FunctionExpression:p(function(n,t,i,r){var u=n.body.scope,f=u.fnType;return r&&!f.name&&(f.name=r),i(n.body,t,"ScopeBody"),hi(n,u)||ci(u),n.id&&u.getProp(n.id.name).addType(f),f}),SequenceExpression:p(function(n,t,i){for(var r=0,u=n.expressions.length-1;r<u;++r)h(n.expressions[r],t,i,o);return h(n.expressions[u],t,i)}),UnaryExpression:p(function(n,t,i){return h(n.argument,t,i,o),pt(n.operator)}),UpdateExpression:p(function(n,t,i){return h(n.argument,t,i,o),e.num}),BinaryExpression:p(function(n,t,i){var r,u,f;return n.operator=="+"?(r=h(n.left,t,i),u=h(n.right,t,i),r.hasType(e.str)||u.hasType(e.str))?e.str:r.hasType(e.num)&&u.hasType(e.num)?e.num:(f=new c,r.propagate(new ui(u,f)),u.propagate(new ui(r,f)),f):(h(n.left,t,i,o),h(n.right,t,i,o),wt(n.operator)?e.bool:e.num)}),AssignmentExpression:p(function(n,t,i){var r,f,u,s,v;if(n.left.type=="MemberExpression"?(u=ct(n.left,t,i),n.left.object.type=="Identifier"&&(f=n.left.object.name+"."+u)):f=n.left.name,n.operator!="="&&n.operator!="+="?(h(n.right,t,i,o),r=e.num):r=h(n.right,t,i,null,f),n.left.type=="MemberExpression"){if(s=h(n.left.object,t,i),u=="prototype"&&b(t,20),u=="<i>"){var c=n.left.property.name,l=t.props[c],a=l&&l.iteratesOver;if(a)return b(t,20),v=n.right.type=="MemberExpression"&&n.right.computed&&n.right.property.name==c,a.forAllProps(function(n,t,i){i&&n!="prototype"&&n!="<i>"&&s.propagate(new ri(n,v?t:o))}),r}s.propagate(new ri(u,r,n.left.property))}else r.propagate(t.defVar(n.left.name,n.left));return r}),LogicalExpression:ut(function(n,t,i,r){h(n.left,t,i,r);h(n.right,t,i,r)}),ConditionalExpression:ut(function(n,t,i,r){h(n.test,t,i,o);h(n.consequent,t,i,r);h(n.alternate,t,i,r)}),NewExpression:ut(function(n,t,i,r,u){var f,o,s,e;for(n.callee.type=="Identifier"&&(n.callee.name in t.props)&&b(t,20),f=0,o=[];f<n.arguments.length;++f)o.push(h(n.arguments[f],t,i));s=h(n.callee,t,i);e=new c;s.propagate(new fr(e,u&&/\.prototype$/.test(u)));e.propagate(r,wi);s.propagate(new st(e,o,n.arguments,new sr(r)))}),CallExpression:ut(function(n,t,i,r){for(var l,o,s,c,u=0,f=[];u<n.arguments.length;++u)f.push(h(n.arguments[u],t,i));n.callee.type=="MemberExpression"?(l=h(n.callee.object,t,i),o=ct(n.callee,t,i),(o=="call"||o=="apply")&&t.fnType&&t.fnType.args.indexOf(l)>-1&&b(t,30),l.propagate(new ur(o,f,n.arguments,r))):(s=h(n.callee,t,i),t.fnType&&t.fnType.args.indexOf(s)>-1&&b(t,30),c=s.getFunctionType(),c&&c.instantiateScore&&t.fnType&&b(t,c.instantiateScore/5),s.propagate(new st(e.topScope,f,n.arguments,r)))}),MemberExpression:ut(function(n,t,i,r){var u=ct(n,t),s=h(n.object,t,i),f=s.getProp(u),o;if(u=="<i>"&&(o=h(n.property,t,i),!o.hasType(e.num)))return f.propagate(r,ki);f.propagate(r)}),Identifier:p(function(n,t){return n.name!="arguments"||!t.fnType||n.name in t.props||t.defProp(n.name,t.fnType.originNode).addType(new y(t.fnType.arguments=new c)),t.getProp(n.name)}),ThisExpression:p(function(n,t){return t.fnType?t.fnType.self:e.topScope}),Literal:p(function(n){return li(n)})};bt=r.make({Expression:function(n,t,i){h(n,t,i,o)},FunctionDeclaration:function(n,t,i){var r=n.body.scope,f=r.fnType,u;i(n.body,t,"ScopeBody");hi(n,r)||ci(r);u=t.getProp(n.id.name);u.addType(f)},VariableDeclaration:function(n,t,i){for(var r,f,u=0;u<n.declarations.length;++u)r=n.declarations[u],f=t.getProp(r.id.name),r.init&&h(r.init,t,i,f,r.id.name)},ReturnStatement:function(n,t,i){if(n.argument){var r=o;t.fnType&&(t.fnType.retval==o&&(t.fnType.retval=new c),r=t.fnType.retval);h(n.argument,t,i,r)}},ForInStatement:function(n,t,i){var u=h(n.right,t,i),r;(n.right.type=="Identifier"&&n.right.name in t.props||n.right.type=="MemberExpression"&&n.right.property.name=="prototype")&&(b(t,5),n.left.type=="Identifier"?r=n.left.name:n.left.type=="VariableDeclaration"&&(r=n.left.declarations[0].id.name),r&&r in t.props&&(t.getProp(r).iteratesOver=u));i(n.body,t,"Statement")},ScopeBody:function(n,t,i){i(n,n.scope||t)}});vi=n.parse=function(n,r,u){var f;try{f=t.parse(n,u)}catch(e){f=i.parse_dammit(n,u)}return kt(r,"postParse",f,n),f};n.analyze=function(t,i,u,f){typeof t=="string"&&(t=vi(t));i||(i="file#"+e.origins.length);n.addOrigin(e.curOrigin=i);u||(u=e.topScope);r.recursive(t,u,null,yt);kt(f,"preInfer",t,u);r.recursive(t,u,null,bt);kt(f,"postInfer",t,u);e.curOrigin=null};n.purge=function(n,t,i){var s=yr(n,t,i),f,r,u,h,o;++e.purgeGen;e.topScope.purge(s);for(f in e.props){for(r=e.props[f],u=0;u<r.length;++u)h=r[u],o=h.props[f],(!o||s(o,o.originNode))&&r.splice(u--,1);r.length||delete e.props[f]}};c.prototype.purge=function(n){var i,t,r;if(this.purgeGen!=e.purgeGen){for(this.purgeGen=e.purgeGen,t=0;t<this.types.length;++t)i=this.types[t],n(i,i.originNode)?this.types.splice(t--,1):i.purge(n);if(this.forward)for(t=0;t<this.forward.length;++t)r=this.forward[t],n(r)?(this.forward.splice(t--,1),this.props&&(this.props=null)):r.purge&&r.purge(n)}};o.purge=function(){};s.prototype.purge=function(n){var i,t;if(this.purgeGen==e.purgeGen)return!0;this.purgeGen=e.purgeGen;for(i in this.props)t=this.props[i],n(t,t.originNode)&&this.removeProp(i),t.purge(n)};a.prototype.purge=function(n){if(!s.prototype.purge.call(this,n)){this.self.purge(n);this.retval.purge(n);for(var t=0;t<this.args.length;++t)this.args[t].purge(n)}};lt={ArrayExpression:function(n,t){for(var r,u=new c,i=0;i<n.elements.length;++i)r=n.elements[i],r&&l(r,t).propagate(u);return new y(u)},ObjectExpression:function(n){return n.objType},FunctionExpression:function(n){return n.body.scope.fnType},SequenceExpression:function(n,t){return l(n.expressions[n.expressions.length-1],t)},UnaryExpression:function(n){return pt(n.operator)},UpdateExpression:function(){return e.num},BinaryExpression:function(n,t){if(wt(n.operator))return e.bool;if(n.operator=="+"){var i=l(n.left,t),r=l(n.right,t);if(i.hasType(e.str)||r.hasType(e.str))return e.str}return e.num},AssignmentExpression:function(n,t){return l(n.right,t)},LogicalExpression:function(n,t){var i=l(n.left,t);return i.isEmpty()?l(n.right,t):i},ConditionalExpression:function(n,t){var i=l(n.consequent,t);return i.isEmpty()?l(n.alternate,t):i},NewExpression:function(n,t){var i=l(n.callee,t).getFunctionType(),r=i&&i.getProp("prototype").getObjType();return r?d(r,i):o},CallExpression:function(n,t){var i=l(n.callee,t).getFunctionType(),r,u,f;if(!i)return o;if(i.computeRet){for(r=0,u=[];r<n.arguments.length;++r)u.push(l(n.arguments[r],t));return f=o,n.callee.type=="MemberExpression"&&(f=l(n.callee.object,t)),i.computeRet(f,u,n.arguments)}return i.retval},MemberExpression:function(n,t){var i=ct(n,t),r=l(n.object,t).getType();return r?r.getProp(i):i=="<i>"?o:pr(i)},Identifier:function(n,t){return t.hasProp(n.name)||o},ThisExpression:function(n,t){return t.fnType?t.fnType.self:e.topScope},Literal:function(n){return li(n)}};ft=n.searchVisitor=r.make({Function:function(n,t,i){var u=n.body.scope,r;for(n.id&&i(n.id,u),r=0;r<n.params.length;++r)i(n.params[r],u);i(n.body,u,"ScopeBody")},TryStatement:function(n,t,i){n.handler&&i(n.handler.param,t);r.base.TryStatement(n,t,i)},VariableDeclaration:function(n,t,i){for(var u,r=0;r<n.declarations.length;++r)u=n.declarations[r],i(u.id,t),u.init&&i(u.init,t,"Expression")}});n.fullVisitor=r.make({MemberExpression:function(n,t,i){i(n.object,t,"Expression");i(n.property,t,n.computed?"Expression":null)},ObjectExpression:function(n,t,i){for(var r=0;r<n.properties.length;++r)i(n.properties[r].value,t,"Expression"),i(n.properties[r].key,t)}},ft);n.findExpressionAt=function(n,t,i,u,f){var o=f||function(n,t){return t.type=="Identifier"&&t.name=="✖"?!1:lt.hasOwnProperty(t.type)};return r.findNodeAt(n,t,i,o,ft,u||e.topScope)};n.findExpressionAround=function(n,t,i,u,f){var o=f||function(n,i){return t!=null&&i.start>t?!1:i.type=="Identifier"&&i.name=="✖"?!1:lt.hasOwnProperty(i.type)};return r.findNodeAround(n,i,o,ft,u||e.topScope)};n.expressionType=function(n){return l(n.node,n.state)};n.parentNode=function(n,t){function f(t,u,e){if(t.start<=n.start&&t.end>=n.end){var o=i[i.length-1];if(t==n)throw{found:o};o!=t&&i.push(t);r.base[e||t.type](t,u,f);o!=t&&i.pop()}}var i=[];try{f(t,null)}catch(u){if(u.found)return u.found;throw u;}};dt={ArrayExpression:function(n,t,i){return i(n,!0).getProp("<i>")},ObjectExpression:function(n,t,i){for(var u,r=0;r<n.properties.length;++r)if(u=t.properties[r],u.value==t)return i(n,!0).getProp(u.key.name)},UnaryExpression:function(n){return pt(n.operator)},UpdateExpression:function(){return e.num},BinaryExpression:function(n){return wt(n.operator)?e.bool:e.num},AssignmentExpression:function(n,t,i){return i(n.left)},LogicalExpression:function(n,t,i){return i(n,!0)},ConditionalExpression:function(n,t,i){if(n.consequent==t||n.alternate==t)return i(n,!0)},NewExpression:function(n,t,i){return this.CallExpression(n,t,i)},CallExpression:function(n,t,i){for(var f,u,r=0;r<n.arguments.length;r++)if(f=n.arguments[r],f==t){if(u=i(n.callee).getFunctionType(),u instanceof a)return u.args[r];break}},ReturnStatement:function(n,t,i){var f=r.findNodeAround(t.sourceFile.ast,t.start,"Function"),u;if(f&&(u=i(f.node,!0).getFunctionType(),u))return u.retval.getType()}};n.typeFromContext=function(t,i){var r=n.parentNode(i.node,t),u=null;return dt.hasOwnProperty(r.type)&&(u=dt[r.type](r,i.node,function(r,u){var f={node:r,state:i.state},e=u?n.typeFromContext(t,f):n.expressionType(f);return e||o})),u||n.expressionType(i)};tt=!1;n.resetGuessing=function(n){tt=n};n.didGuess=function(){return tt};n.forAllPropertiesOf=function(n,t){n.gatherProperties(t,0)};gt=r.make({},ft);n.findRefs=function(n,t,i,u,f){gt.Identifier=function(n,t){if(n.name==i)for(var r=t;r;r=r.prev)if(r==u&&f(n,t),i in r.props)return};r.recursive(n,t,null,gt)};yi=r.make({Function:function(n,t,i){i(n.body,n.body.scope,"ScopeBody")}});n.findPropRefs=function(n,t,i,u,f){r.simple(n,{MemberExpression:function(n,t){n.computed||n.property.name!=u||l(n.object,t).getType()==i&&f(n.property)},ObjectExpression:function(n,t){if(l(n,t).getType()==i)for(var r=0;r<n.properties.length;++r)n.properties[r].key.name==u&&f(n.properties[r].key)}},yi,t)};pi=n.scopeAt=function(n,t,i){var u=r.findNodeAround(n,t,function(n,t){return n=="ScopeBody"&&t.scope});return u?u.node.scope:i||e.topScope};n.forAllLocalsAt=function(n,t,i,r){var u=pi(n,t,i);u.gatherProperties(r,0)};u=n.def=u.init({},n)});