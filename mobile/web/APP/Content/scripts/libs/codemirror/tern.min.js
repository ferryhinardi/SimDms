(function(n){typeof exports=="object"&&typeof module=="object"?n(require("../../lib/codemirror")):typeof define=="function"&&define.amd?define(["../../lib/codemirror"],n):n(CodeMirror)})(function(n){"use strict";function a(n,t,i){var r=n.docs[t];r?i(s(n,r)):n.options.getFile?n.options.getFile(t,i):i(null)}function f(n,t,i){var r,u,f;for(r in n.docs)if(u=n.docs[r],u.doc==t)return u;if(!i)for(f=0;;++f)if(r="[doc"+(f||"")+"]",!n.docs[r]){i=r;break}return n.addDoc(i,t)}function v(t,i){return typeof i=="string"?t.docs[i]:(i instanceof n&&(i=i.getDoc()),i instanceof n.Doc?f(t,i):void 0)}function tt(n,t,i){var u=f(n,t),s=n.cachedArgHints,r,o;s&&s.doc==t&&e(s.start,i.to)<=0&&(n.cachedArgHints=null);r=u.changed;r==null&&(u.changed=r={from:i.from.line,to:i.from.line});o=i.from.line+(i.text.length-1);i.from.line<r.to&&(r.to=r.to-(i.to.line-o));o>=r.to&&(r.to=o+1);r.from>i.from.line&&(r.from=i.from.line);t.lineCount()>l&&i.to-r.from>100&&setTimeout(function(){u.changed&&u.changed.to-u.changed.from>100&&y(n,u)},200)}function y(n,t){n.server.request({files:[{type:"full",name:t.name,text:s(n,t)}]},function(n){n?window.console.error(n):t.changed=null})}function it(r,f,e){r.request(f,{type:"completions",types:!0,docs:!0,urls:!0},function(s,h){var w,a,b,v,l;if(s)return u(r,f,s);var k=[],d="",y=h.start,p=h.end;for(f.getRange(t(y.line,y.ch-2),y)=='["'&&f.getRange(p,t(p.line,p.ch+2))!='"]'&&(d='"]'),w=0;w<h.completions.length;++w)a=h.completions[w],b=rt(a.type),h.guess&&(b+=" "+i+"guess"),k.push({text:a.name+d,displayText:a.name,className:b,data:a});v={from:y,to:p,list:k};l=null;n.on(v,"close",function(){o(l)});n.on(v,"update",function(){o(l)});n.on(v,"select",function(n,t){o(l);var u=r.options.completionTip?r.options.completionTip(n.data):n.data.doc;u&&(l=c(t.parentNode.getBoundingClientRect().right+window.pageXOffset,t.getBoundingClientRect().top+window.pageYOffset,u),l.className+=" "+i+"hint-doc")});e(v)})}function rt(n){var t;return t=n=="?"?"unknown":n=="number"||n=="string"||n=="bool"?n:/^fn\(/.test(n)?"fn":/^\[/.test(n)?"array":"object",i+"completion "+i+"completion-"+t}function p(n,t,i,f,e){n.request(t,f,function(i,f){var o,s;if(i)return u(n,t,i);n.options.typeTip?o=n.options.typeTip(f):(o=r("span",null,r("strong",null,f.type||"not found")),f.doc&&o.appendChild(document.createTextNode(" — "+f.doc)),f.url&&(o.appendChild(document.createTextNode(" ")),s=o.appendChild(r("a",null,"[docs]")),s.href=f.url,s.target="_blank"));nt(t,o);e&&e()},i)}function ut(i,r){var d,a,f,v,y,p,b,o,s,c,k,l;if((h(i),!r.somethingSelected())&&(d=r.getTokenAt(r.getCursor()).state,a=n.innerMode(r.getMode(),d),a.mode.name=="javascript")&&(f=a.state.lexical,f.info=="call")){y=f.pos||0;p=r.getOption("tabSize");for(var u=r.getCursor().line,nt=Math.max(0,u-9),g=!1;u>=nt;--u){for(b=r.getLine(u),o=0,s=0;;){if(c=b.indexOf("\t",s),c==-1)break;o+=p-(c+o)%p-1;s=c+1}if(v=f.column-o,b.charAt(v)=="("){g=!0;break}}if(g){if(k=t(u,v),l=i.cachedArgHints,l&&l.doc==r.getDoc()&&e(k,l.start)==0)return w(i,r,y);i.request(r,{type:"type",preferFunction:!0,end:k},function(n,t){!n&&t.type&&/^fn\(/.test(t.type)&&(i.cachedArgHints={start:s,type:ft(t.type),name:t.exprName||t.name||"fn",guess:t.guess,doc:r.getDoc()},w(i,r,y))})}}}function w(n,t,u){var e,s,a;h(n);var l=n.cachedArgHints,o=l.type,f=r("span",l.guess?i+"fhint-guess":null,r("span",i+"fname",l.name),"(");for(e=0;e<o.args.length;++e)e&&f.appendChild(document.createTextNode(", ")),s=o.args[e],f.appendChild(r("span",i+"farg"+(e==u?" "+i+"farg-current":""),s.name||"?")),s.type!="?"&&(f.appendChild(document.createTextNode(": ")),f.appendChild(r("span",i+"type",s.type)));f.appendChild(document.createTextNode(o.rettype?") -> ":")"));o.rettype&&f.appendChild(r("span",i+"type",o.rettype));a=t.cursorCoords(null,"page");n.activeArgHints=c(a.right+1,a.bottom,f)}function ft(n){function f(i){for(var u=0,f=t,r;;){if(r=n.charAt(t),i.test(r)&&!u)return n.slice(f,t);/[{\[\(]/.test(r)?++u:/[}\]\)]/.test(r)&&--u;++t}}var u=[],t=3,i,r;if(n.charAt(t)!=")")for(;;){if(i=n.slice(t).match(/^([^, \(\[\{]+): /),i&&(t+=i[0].length,i=i[1]),u.push({name:i,type:f(/[\),]/)}),n.charAt(t)==")")break;t+=2}return r=n.slice(t).match(/^\) -> (.*)$/),{args:u,rettype:r&&r[1]}}function et(n,t){function i(i){var e={type:"definition",variable:i||null},r=f(n,t.getDoc());n.server.request(d(n,r,e),function(i,f){if(i)return u(n,t,i);if(!f.file&&f.url){window.open(f.url);return}if(f.file){var e=n.docs[f.file],o;if(e&&(o=st(e.doc,f))){n.jumpStack.push({file:r.name,start:t.getCursor("from"),end:t.getCursor("to")});b(n,r,e,o.start,o.end);return}}u(n,t,"Could not find a definition.")})}ht(t)?i():g(t,"Jump to variable",function(n){n&&i(n)})}function ot(n,t){var i=n.jumpStack.pop(),r=i&&n.docs[i.file];r&&b(n,f(n,t.getDoc()),r,i.start,i.end)}function b(n,t,i,r,u){i.doc.setSelection(r,u);t!=i&&n.options.switchToDoc&&(h(n),n.options.switchToDoc(i.name,i.doc))}function st(n,i){for(var l,r,a,o,f,v,u=i.context.slice(0,i.contextOffset).split("\n"),e=i.start.line-(u.length-1),s=t(e,(u.length==1?i.start.ch:n.getLine(e).length)-u[0].length),h=n.getLine(e).slice(s.ch),c=e+1;c<n.lineCount()&&h.length<i.context.length;++c)h+="\n"+n.getLine(c);if(h.slice(0,i.context.length)==i.context)return i;for(l=n.getSearchCursor(i.context,0,!1),a=Infinity;l.findNext();)o=l.from(),f=Math.abs(o.line-s.line)*1e4,f||(f=Math.abs(o.ch-s.ch)),f<a&&(r=o,a=f);return r?(u.length==1?r.ch+=u[0].length:r=t(r.line+(u.length-1),u[u.length-1].length),v=i.start.line==i.end.line?t(r.line,r.ch+(i.end.ch-i.start.ch)):t(r.line+(i.end.line-i.start.line),i.end.ch),{start:r,end:v}):null}function ht(n){var t=n.getCursor("end"),i=n.getTokenAt(t);return i.start<t.ch&&(i.type=="comment"||i.type=="string")?!1:/[\w)\]]/.test(n.getLine(t.line).slice(Math.max(t.ch-1,0),t.ch+1))}function ct(n,t){var i=t.getTokenAt(t.getCursor());if(!/\w/.test(i.string))return u(n,t,"Not at a variable");g(t,"New name for "+i.string,function(i){n.request(t,{type:"rename",newName:i,fullDocs:!0},function(i,r){if(i)return u(n,t,i);at(n,r.changes)})})}function lt(n,t){var i=f(n,t.doc).name;n.request(t,{type:"refs"},function(r,f){var h,s,c,o;if(r)return u(n,t,r);for(h=[],s=0,c=0;c<f.refs.length;c++)o=f.refs[c],o.file==i&&(h.push({anchor:o.start,head:o.end}),e(s,o.start)>=0&&e(s,o.end)<=0&&(s=h.length-1));t.setSelections(h,s)})}function at(n,t){for(var o,s,f,h,i,u=Object.create(null),r=0;r<t.length;++r)i=t[r],(u[i.file]||(u[i.file]=[])).push(i);for(o in u)if(s=n.docs[o],f=u[o],s)for(f.sort(function(n,t){return e(t.start,n.start)}),h="*rename"+ ++k,r=0;r<f.length;++r)i=f[r],s.doc.replaceRange(i.text,i.start,i.end,h)}function d(n,i,r,u){var e=[],o=0,c=!r.fullDocs,h,a,f;c||delete r.fullDocs;typeof r=="string"&&(r={type:r});r.lineCharPositions=!0;r.end==null&&(r.end=u||i.doc.getCursor("end"),i.doc.somethingSelected()&&(r.start=i.doc.getCursor("start")));h=r.start||r.end;i.changed?i.doc.lineCount()>l&&c!==!1&&i.changed.to-i.changed.from<100&&i.changed.from<=h.line&&i.changed.to>r.end.line?(e.push(vt(i,h,r.end)),r.file="#0",o=e[0].offsetLines,r.start!=null&&(r.start=t(r.start.line- -o,r.start.ch)),r.end=t(r.end.line-o,r.end.ch)):(e.push({type:"full",name:i.name,text:s(n,i)}),r.file=i.name,i.changed=null):r.file=i.name;for(a in n.docs)f=n.docs[a],f.changed&&f!=i&&(e.push({type:"full",name:f.name,text:s(n,f)}),f.changed=null);return{query:r,files:e}}function vt(i,r,u){for(var a,w,v,h,y,o=i.doc,f=null,c=null,e,l=4,s=r.line-1,p=Math.max(0,s-50);s>=p;--s)(a=o.getLine(s),w=a.search(/\bfunction\b/),w<0)||(h=n.countColumn(a,null,l),f!=null&&f<=h)||(f=h,c=s);if(c==null&&(c=p),v=Math.min(o.lastLine(),u.line+20),f==null||f==n.countColumn(o.getLine(r.line),null,l))e=v;else for(e=u.line+1;e<v;++e)if(h=n.countColumn(o.getLine(e),null,l),h<=f)break;return y=t(c,0),{type:"part",name:i.name,offsetLines:y.line,text:o.getRange(y,t(e,0))}}function r(n,t){var u=document.createElement(n),r,i;for(t&&(u.className=t),r=2;r<arguments.length;++r)i=arguments[r],typeof i=="string"&&(i=document.createTextNode(i)),u.appendChild(i);return u}function g(n,t,i){n.openDialog?n.openDialog(t+": <input type=text>",i):i(prompt(t,""))}function nt(t,i){function h(){s=!0;f||r()}function r(){(t.state.ternTooltip=null,u.parentNode)&&(t.off("cursorActivity",r),t.off("blur",r),t.off("scroll",r),yt(u))}var e,u,f,s;t.state.ternTooltip&&o(t.state.ternTooltip);e=t.cursorCoords();u=t.state.ternTooltip=c(e.right+1,e.bottom,i);f=!1;s=!1;n.on(u,"mousemove",function(){f=!0});n.on(u,"mouseout",function(t){n.contains(u,t.relatedTarget||t.toElement)||(s?r():f=!1)});setTimeout(h,1700);t.on("cursorActivity",r);t.on("blur",r);t.on("scroll",r)}function c(n,t,u){var f=r("div",i+"tooltip",u);return f.style.left=n+"px",f.style.top=t+"px",document.body.appendChild(f),f}function o(n){var t=n&&n.parentNode;t&&t.removeChild(n)}function yt(n){n.style.opacity="0";setTimeout(function(){o(n)},1100)}function u(n,t,i){n.options.showError?n.options.showError(t,i):nt(t,String(i))}function h(n){n.activeArgHints&&(o(n.activeArgHints),n.activeArgHints=null)}function s(n,t){var i=t.doc.getValue();return n.options.fileFilter&&(i=n.options.fileFilter(i,t.name,t.doc)),i}function pt(n){function r(n,r){r&&(n.id=++u,t[u]=r);i.postMessage(n)}var i=n.worker=new Worker(n.options.workerScript),u,t;i.postMessage({type:"init",defs:n.options.defs,plugins:n.options.plugins,scripts:n.options.workerDeps});u=0;t={};i.onmessage=function(i){var u=i.data;u.type=="getFile"?a(n,u.name,function(n,t){r({type:"getFile",err:String(n),text:t,id:u.id})}):u.type=="debug"?window.console.log(u.message):u.id&&t[u.id]&&(t[u.id](u.err,u.body),delete t[u.id])};i.onerror=function(n){for(var i in t)t[i](n);t={}};this.addFile=function(n,t){r({type:"add",name:n,text:t})};this.delFile=function(n){r({type:"del",name:n})};this.request=function(n,t){r({type:"req",body:n},t)}}var k,e;n.TernServer=function(n){var i=this,t;this.options=n||{};t=this.options.plugins||(this.options.plugins={});t.doc_comment||(t.doc_comment=!0);this.server=this.options.useWorker?new pt(this):new tern.Server({getFile:function(n,t){return a(i,n,t)},async:!0,defs:this.options.defs||[],plugins:t});this.docs=Object.create(null);this.trackChange=function(n,t){tt(i,n,t)};this.cachedArgHints=null;this.activeArgHints=null;this.jumpStack=[];this.getHint=function(n,t){return it(i,n,t)};this.getHint.async=!0};n.TernServer.prototype={addDoc:function(t,i){var r={doc:i,name:t,changed:null};this.server.addFile(t,s(this,r));n.on(i,"change",this.trackChange);return this.docs[t]=r},delDoc:function(t){var i=v(this,t);i&&(n.off(i.doc,"change",this.trackChange),delete this.docs[i.name],this.server.delFile(i.name))},hideDoc:function(n){h(this);var t=v(this,n);t&&t.changed&&y(this,t)},complete:function(n){n.showHint({hint:this.getHint})},showType:function(n,t,i){p(this,n,t,"type",i)},showDocs:function(n,t,i){p(this,n,t,"documentation",i)},updateArgHints:function(n){ut(this,n)},jumpToDef:function(n){et(this,n)},jumpBack:function(n){ot(this,n)},rename:function(n){ct(this,n)},selectName:function(n){lt(this,n)},request:function(n,t,i,r){var u=this,e=f(this,n.getDoc()),o=d(this,e,t,r);this.server.request(o,function(n,r){!n&&u.options.responseFilter&&(r=u.options.responseFilter(e,t,o,n,r));i(n,r)})},destroy:function(){this.worker&&(this.worker.terminate(),this.worker=null)}};var t=n.Pos,i="CodeMirror-Tern-",l=250;k=0;e=n.cmpPos});