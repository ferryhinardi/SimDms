(function(n){if(typeof exports=="object"&&typeof module=="object")return exports.init=n;if(typeof define=="function"&&define.amd)return define({init:n});tern.def={init:n}})(function(n,t){"use strict";function l(n,t){return Object.prototype.hasOwnProperty.call(n,t)}function r(n,r,f,e){var o=new i(n,null,f,e).parseType(r,!0),s;if(/^fn\(/.test(n))for(s=0;s<o.args.length;++s)(function(n){var i=o.args[n];i instanceof t.Fn&&i.args&&i.args.length&&u(o,function(r,u){var f=u[n];f&&f.propagate(new t.IsCallee(t.cx().topScope,i.args,null,t.ANull))})})(s);return o}function u(n,t,i){var r=n.computeRet,u=n.retval;n.computeRet=function(n,f,e){var o=t(n,f,e),s=r?r(n,f,e):u;return i?o:s}}function c(n){var t=Object.create(n.prototype);return t.props=Object.create(null),t.isShell=!0,t}function v(n){if(!n["!type"]||/^(fn\(|\[)/.test(n["!type"]))return!1;for(var t in n)if(t!="!type"&&t!="!doc"&&t!="!url"&&t!="!span"&&t!="!data")return!1;return!0}function o(n,i,r){var f,u,e,s;if(!n){if(f=i["!type"],f)if(/^fn\(/.test(f))n=c(t.Fn);else if(f.charAt(0)=="[")n=c(t.Arr);else throw new Error("Invalid !type spec: "+f);else n=i["!stdProto"]?t.cx().protos[i["!stdProto"]]:c(t.Obj);n.name=r}for(u in i)if(l(i,u)&&u.charCodeAt(0)!=33){if(e=i[u],typeof e=="string"||v(e))continue;s=n.defProp(u);o(s.getObjType(),e,r?r+"."+u:u).propagate(s)}return n}function s(n,i,u){var y,p,h,c,o;if(n.isShell&&(delete n.isShell,y=i["!type"],y?r(y,u,n):(p=i["!proto"]&&r(i["!proto"]),t.Obj.call(n,p instanceof t.Obj?p:!0,u))),h=i["!effects"],h&&n instanceof t.Fn)for(c=0;c<h.length;++c)a(h[c],n);k(i,n);for(o in i)if(l(i,o)&&o.charCodeAt(0)!=33){var f=i[o],e=n.defProp(o),w=u?u+"."+o:o;if(typeof f=="string")e.isEmpty()&&r(f,w).propagate(e);else{if(v(f))if(e.isEmpty())r(f["!type"],w,null,!0).propagate(e);else continue;else s(e.getObjType(),f,w);f["!doc"]&&(e.doc=f["!doc"]);f["!url"]&&(e.url=f["!url"]);f["!span"]&&(e.span=f["!span"])}}return n}function k(n,t){n["!doc"]&&(t.doc=n["!doc"]);n["!url"]&&(t.url=n["!url"]);n["!span"]&&(t.span=n["!span"]);n["!data"]&&(t.metaData=n["!data"])}function y(n,i){var u=t.cx().parent,f=u&&u.passes&&u.passes[n],r;if(f)for(r=0;r<f.length;r++)f[r](i)}function d(n,i){var r=t.cx(),e,u,h;if(t.addOrigin(r.curOrigin=n["!name"]||"env#"+r.origins.length),r.localDefs=r.definitions[r.curOrigin]=Object.create(null),y("preLoadDef",n),o(i,n),e=n["!define"],e){for(u in e)h=e[u],r.localDefs[u]=typeof h=="string"?f(h):o(null,h,u);for(u in e)h=e[u],typeof h!="string"&&s(r.localDefs[u],e[u],u)}s(i,n);y("postLoadDef",n);r.curOrigin=r.localDefs=null}var i=n.TypeParser=function(n,t,i,r){this.pos=t||0;this.spec=n;this.base=i;this.forceNew=r},a,e,f,h,p,w,b;return i.prototype={eat:function(n){if(n.length==1?this.spec.charAt(this.pos)==n:this.spec.indexOf(n,this.pos)==this.pos)return this.pos+=n.length,!0},word:function(n){for(var i="",t,n=n||/[\w$]/;(t=this.spec.charAt(this.pos))&&n.test(t);)i+=t,++this.pos;return i},error:function(){throw new Error("Unrecognized type spec: "+this.spec+" (at "+this.pos+")");},parseFnType:function(n,i){var o=[],s=[],l,f,e,r,h,c,u;if(!this.eat(")"))for(l=0;;++l)if(f=this.spec.indexOf(": ",this.pos),f!=-1&&(e=this.spec.slice(this.pos,f),/^[$\w?]+$/.test(e)?this.pos=f+2:e=null),s.push(e),o.push(this.parseType()),!this.eat(", ")){this.eat(")")||this.error();break}return this.eat(" -> ")?i&&this.spec.indexOf("!",this.pos)>-1?(r=t.ANull,c=this.pos,h=this.parseRetType()):r=this.parseType():r=t.ANull,i&&(u=this.base)?t.Fn.call(this.base,n,t.ANull,o,s,r):u=new t.Fn(n,t.ANull,o,s,r),h&&(u.computeRet=h),c!=null&&(u.computeRetSource=this.spec.slice(c,this.pos)),u},parseType:function(n,i){for(var u,r=!1,f;;){if(f=this.parseTypeInner(n,i),r?f.propagate(r):u=f,!this.eat("|"))break;r||(r=new t.AVal,u.propagate(r),u=r)}return u},parseTypeInner:function(n,i){var u,e,r;return this.eat("fn(")?this.parseFnType(n,i):this.eat("[")?(u=this.parseType(),this.eat("]")||this.error(),i&&this.base)?(t.Arr.call(this.base,u),this.base):new t.Arr(u):this.eat("+")?(e=this.word(/[\w$<>\.!]/),r=f(e+".prototype"),r instanceof t.Obj||(r=f(e)),!(r instanceof t.Obj))?r:i&&this.forceNew?new t.Obj(r):t.getInstance(r):this.eat("?")?t.ANull:this.fromWord(this.word(/[\w$<>\.!`]/))},fromWord:function(n){var i=t.cx();switch(n){case"number":return i.num;case"string":return i.str;case"bool":return i.bool;case"<top>":return i.topScope}return i.localDefs&&n in i.localDefs?i.localDefs[n]:f(n)},parseBaseRetType:function(){var r,u,i,n,f,e;return this.eat("[")?(r=this.parseRetType(),this.eat("]")||this.error(),function(n,i){return new t.Arr(r(n,i))}):this.eat("+")?(u=this.parseRetType(),i=function(n,i){var r=u(n,i);return(r instanceof t.Fn&&r.hasProp("prototype")&&(r=r.getProp("prototype").getObjType()),!(r instanceof t.Obj))?r:new t.Obj(r)},this.eat("["))?this.parsePoly(i):i:this.eat("!")?(n=this.word(/\d/),n?(n=Number(n),function(i,r){return r[n]||t.ANull}):this.eat("this")?function(n){return n}:this.eat("custom:")?(f=this.word(/[\w$]/),h[f]||function(){return t.ANull}):this.fromWord("!"+n+this.word(/[\w$<>\.!]/))):(e=this.parseType(),function(){return e})},extendRetType:function(n){var i=this.word(/[\w<>$!]/)||this.error();return i=="!ret"?function(i,r){var u=n(i,r),f;return u.retval?u.retval:(f=new t.AVal,u.propagate(new t.IsCallee(t.ANull,[],null,f)),f)}:function(t,r){return n(t,r).getProp(i)}},parsePoly:function(n){var r="<i>",i,u;return(i=this.spec.slice(this.pos).match(/^\s*(\w+)\s*=\s*/))&&(r=i[1],this.pos+=i[0].length),u=this.parseRetType(),this.eat("]")||this.error(),function(i,f){var e=n(i,f);return e instanceof t.Obj&&u(i,f).propagate(e.defProp(r)),e}},parseRetType:function(){for(var n=this.parseBaseRetType();this.eat(".");)n=this.extendRetType(n);return n}},a=n.parseEffect=function(n,r){var e,a,v,o,f,y,p;if(n.indexOf("propagate ")==0)f=new i(n,10),a=f.parseRetType(),f.eat(" ")||f.error(),v=f.parseRetType(),u(r,function(n,t){a(n,t).propagate(v(n,t))});else if(n.indexOf("call ")==0){var s=n.indexOf("and return ",5)==5,f=new i(n,s?16:5),w=f.parseRetType(),c=null,l=[];for(f.eat(" this=")&&(c=f.parseRetType());f.eat(" ");)l.push(f.parseRetType());u(r,function(n,i){for(var u,e=w(n,i),o=c?c(n,i):t.ANull,f=[],r=0;r<l.length;++r)f.push(l[r](n,i));return u=s?new t.AVal:t.ANull,e.propagate(new t.IsCallee(o,f,null,u)),u},s)}else if(e=n.match(/^custom (\S+)\s*(.*)/))o=h[e[1]],o&&u(r,e[2]?o(e[2]):o);else if(n.indexOf("copy ")==0)f=new i(n,5),y=f.parseRetType(),f.eat(" "),p=f.parseRetType(),u(r,function(n,i){var r=y(n,i),u=p(n,i);r.forAllProps(function(n,i,r){r&&n!="<i>"&&u.propagate(new t.PropHasSubset(n,i))})});else throw new Error("Unknown effect type: "+n);},f=n.parsePath=function(n,i){var u=t.cx(),v=u.paths[n],y=n,r,o,l,h,f,s,a,c;if(v!=null)return v;if(u.paths[n]=t.ANull,r=i||e||u.topScope,u.localDefs)for(o in u.localDefs)if(n.indexOf(o)==0){if(n==o)return u.paths[n]=u.localDefs[n];if(n.charAt(o.length)=="."){r=u.localDefs[o];n=n.slice(o.length+1);break}}for(l=n.split("."),h=0;h<l.length&&r!=t.ANull;++h)f=l[h],f.charAt(0)=="!"?f=="!proto"?r=r instanceof t.Obj&&r.proto||t.ANull:(s=r.getFunctionType(),s?f=="!ret"?r=s.retval&&s.retval.getType(!1)||t.ANull:(a=s.args&&s.args[Number(f.slice(1))],r=a&&a.getType(!1)||t.ANull):r=t.ANull):r instanceof t.Obj&&(c=f=="prototype"&&r instanceof t.Fn?r.getProp(f):r.props[f],r=!c||c.isEmpty()?t.ANull:c.types[0]);return u.paths[y]=r==t.ANull?null:r,r},n.load=function(n,i){i||(i=t.cx().topScope);var r=e;e=i;try{d(n,i)}finally{e=r}},n.parse=function(n,i,u){var f=t.cx();i&&(f.origin=i,f.localDefs=f.definitions[i]);try{return typeof n=="string"?r(n,u):s(o(null,n,u),n,u)}finally{i&&(f.origin=f.localDefs=null)}},h=Object.create(null),t.registerFunction=function(n,t){h[n]=t},p=t.constraint("created, target, spec",{addType:function(n){var u,i,f,r,o,e;if(n instanceof t.Obj&&this.created++<5){if(u=new t.Obj(n),i=this.spec,i instanceof t.AVal&&(i=i.getObjType(!1)),i instanceof t.Obj)for(f in i.props)r=i.props[f].types[0],o=u.defProp(f),r&&r instanceof t.Obj&&r.props.value&&(e=r.props.value.getType(!1),e&&o.addType(e));this.target.addType(u)}}}),t.registerFunction("Object_create",function(n,i,r){if(r&&r.length&&r[0].type=="Literal"&&r[0].value==null)return new t.Obj;var u=new t.AVal;return i[0]&&i[0].propagate(new p(0,u,i[1])),u}),w=t.constraint("target",{addType:function(n){n instanceof t.Obj&&(n.hasProp("value")?n.getProp("value").propagate(this.target):n.hasProp("get")&&n.getProp("get").propagate(new t.IsCallee(t.ANull,[],null,this.target)))}}),t.registerFunction("Object_defineProperty",function(n,i,r){if(r&&r.length>=3&&r[1].type=="Literal"&&typeof r[1].value=="string"){var f=i[0],u=new t.AVal;f.propagate(new t.PropHasSubset(r[1].value,u,r[1]));i[2].propagate(new w(u))}return t.ANull}),b=t.constraint("self, args, target",{addType:function(n){if(n instanceof t.Fn){this.target.addType(new t.Fn(n.name,n.self,n.args.slice(this.args.length),n.argNames.slice(this.args.length),n.retval));this.self.propagate(n.self);for(var i=0;i<Math.min(n.args.length,this.args.length);++i)this.args[i].propagate(n.args[i])}}}),t.registerFunction("Function_bind",function(n,i){if(!i.length)return t.ANull;var r=new t.AVal;return n.propagate(new b(i[0],i.slice(1),r)),r}),t.registerFunction("Array_ctor",function(n,i){var u=new t.Arr,f,r;if(i.length!=1||!i[0].hasType(t.cx().num))for(f=u.getProp("<i>"),r=0;r<i.length;++r)i[r].propagate(f);return u}),t.registerFunction("Promise_ctor",function(n,i,r){var e,o;if(i.length<1)return t.ANull;var u=new t.Obj(t.cx().definitions.ecma6["Promise.prototype"]),s=u.defProp("value",r&&r[0]),f=new t.AVal;return f.propagate(s),e=new t.Fn("execute",t.ANull,[f],["value"],t.ANull),o=t.cx().definitions.ecma6.promiseReject,i[0].propagate(new t.IsCallee(t.ANull,[e,o],null,t.ANull)),u}),n});