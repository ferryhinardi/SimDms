(function(n){typeof exports=="object"&&typeof module=="object"?n(require("../../lib/codemirror"),require("diff_match_patch")):typeof define=="function"&&define.amd?define(["../../lib/codemirror","diff_match_patch"],n):n(CodeMirror,diff_match_patch)})(function(n,t){"use strict";function s(n,t){this.mv=n;this.type=t;this.classes=t=="left"?{chunk:"CodeMirror-merge-l-chunk",start:"CodeMirror-merge-l-chunk-start",end:"CodeMirror-merge-l-chunk-end",insert:"CodeMirror-merge-l-inserted",del:"CodeMirror-merge-l-deleted",connect:"CodeMirror-merge-l-connect"}:{chunk:"CodeMirror-merge-r-chunk",start:"CodeMirror-merge-r-chunk-start",end:"CodeMirror-merge-r-chunk-end",insert:"CodeMirror-merge-r-inserted",del:"CodeMirror-merge-r-deleted",connect:"CodeMirror-merge-r-connect"}}function e(t){t.diffOutOfDate&&(t.diff=ut(t.orig.getValue(),t.edit.getValue()),t.chunks=ft(t.diff),t.diffOutOfDate=!1,n.signal(t.edit,"updateDiff",t.diff))}function lt(n){function s(r){u=!0;o=!1;r=="full"&&(n.svg&&c(n.svg),n.copyButtons&&c(n.copyButtons),v(n.edit,t.marked,n.classes),v(n.orig,i.marked,n.classes),t.from=t.to=i.from=i.to=0);e(n);n.showDifferences&&(nt(n.edit,n.diff,t,DIFF_INSERT,n.classes),nt(n.orig,n.diff,i,DIFF_DELETE,n.classes));f(n);n.mv.options.connect=="align"&&p(n);u=!1}function r(t){u||(n.dealigned=!0,h(t))}function h(n){u||o||(clearTimeout(l),n===!0&&(o=!0),l=setTimeout(s,n===!0?20:250))}function a(u,f){n.diffOutOfDate||(n.diffOutOfDate=!0,t.from=t.to=i.from=i.to=0);r(f.text.length-1!=f.to.line-f.from.line)}var t={from:0,to:0,marked:[]},i={from:0,to:0,marked:[]},l,o=!1;n.edit.on("change",a);n.orig.on("change",a);n.edit.on("markerAdded",r);n.edit.on("markerCleared",r);n.orig.on("markerAdded",r);n.orig.on("markerCleared",r);n.edit.on("viewportChange",function(){h(!1)});n.orig.on("viewportChange",function(){h(!1)});return s(),s}function at(n){n.edit.on("scroll",function(){a(n,DIFF_INSERT)&&f(n)});n.orig.on("scroll",function(){a(n,DIFF_DELETE)&&f(n)})}function a(n,t){var u,f,l,i,s,p;if(n.diffOutOfDate)return!1;if(!n.lockScroll)return!0;if(l=+new Date,t==DIFF_INSERT?(u=n.edit,f=n.orig):(u=n.orig,f=n.edit),u.state.scrollSetBy==n&&(u.state.scrollSetAt||0)+50>l)return!1;if(i=u.getScrollInfo(),n.mv.options.connect=="align")r=i.top;else{var o=.5*i.clientHeight,y=i.top+o,w=u.lineAtHeight(y,"local"),h=bt(n.chunks,w,t==DIFF_INSERT),a=d(u,t==DIFF_INSERT?h.edit:h.orig),v=d(f,t==DIFF_INSERT?h.orig:h.edit),b=(y-a.top)/(a.bot-a.top),r=v.top-o+b*(v.bot-v.top),c,e;r>i.top&&(e=i.top/o)<1?r=r*e+i.top*(1-e):(c=i.height-i.clientHeight-i.top)<o&&(s=f.getScrollInfo(),p=s.height-s.clientHeight-r,p>c&&(e=c/o)<1&&(r=r*e+(s.height-s.clientHeight-c)*(1-e)))}return f.scrollTo(i.left,r),f.state.scrollSetAt=l,f.state.scrollSetBy=n,!0}function d(n,t){var i=t.after;return i==null&&(i=n.lastLine()+1),{top:n.heightAtLine(t.before||0,"local"),bot:n.heightAtLine(i,"local")}}function g(n,t,i){n.lockScroll=t;t&&i!=!1&&a(n,DIFF_INSERT)&&f(n);n.lockButton.innerHTML=t?"⇛⇚":"⇛&nbsp;&nbsp;⇚"}function v(t,i,r){for(var u,f=0;f<i.length;++f)u=i[f],u instanceof n.TextMarker?u.clear():u.parent&&(t.removeLineClass(u,"background",r.chunk),t.removeLineClass(u,"background",r.start),t.removeLineClass(u,"background",r.end));i.length=0}function nt(n,t,i,r,u){var f=n.getViewport();n.operation(function(){i.from==i.to||f.from-i.to>20||i.from-f.to>20?(v(n,i.marked,u),y(n,t,r,i.marked,f.from,f.to,u),i.from=f.from,i.to=f.to):(f.from<i.from&&(y(n,t,r,i.marked,f.from,i.from,u),i.from=f.from),f.to>i.to&&(y(n,t,r,i.marked,i.to,f.to,u),i.to=f.to))})}function y(n,t,r,u,f,e,o){function y(t,i){for(var h,r=Math.max(f,t),c=Math.min(e,i),s=r;s<c;++s)h=n.addLineClass(s,"background",o.chunk),s==t&&n.addLineClass(h,"background",o.start),s==i-1&&n.addLineClass(h,"background",o.end),u.push(h);t==i&&r==i&&c==i&&(r?u.push(n.addLineClass(r-1,"background",o.end)):u.push(n.addLineClass(r,"background",o.start)))}for(var a,v,s=i(0,0),nt=i(f,0),tt=n.clipPos(i(e-1)),it=r==DIFF_DELETE?o.del:o.insert,c=0,h=0;h<t.length;++h){var p=t[h],w=p[0],b=p[1];if(w==DIFF_EQUAL)a=s.line+(ot(t,h)?0:1),l(s,b),v=s.line+(et(t,h)?1:0),v>a&&(h&&y(c,a),c=v);else if(w==r){var k=l(s,b,!0),d=ti(nt,s),g=ni(tt,k);ii(d,g)||u.push(n.markText(d,g,{className:it}));s=k}}c<=s.line&&y(c,s.line+1)}function f(n){var r,i,t;if(n.showDifferences){n.svg&&(c(n.svg),r=n.gap.offsetWidth,ht(n.svg,"width",r,"height",n.gap.offsetHeight));n.copyButtons&&c(n.copyButtons);var u=n.edit.getViewport(),f=n.orig.getViewport(),e=n.edit.getScrollInfo().top,o=n.orig.getScrollInfo().top;for(i=0;i<n.chunks.length;i++)t=n.chunks[i],t.editFrom<=u.to&&t.editTo>=u.from&&t.origFrom<=f.to&&t.origTo>=f.from&&wt(n,t,o,e,r)}}function h(n,t){for(var i,u=0,f=0,r=0;r<t.length;r++){if(i=t[r],i.editTo>n&&i.editFrom<=n)return null;if(i.editFrom>n)break;u=i.editTo;f=i.origTo}return f+(n-u)}function vt(n,t){for(var i,u,e,f=[],r=0;r<n.chunks.length;r++)i=n.chunks[r],f.push([i.origTo,i.editTo,t?h(i.editTo,t.chunks):null]);if(t)for(r=0;r<t.chunks.length;r++){for(i=t.chunks[r],u=0;u<f.length;u++)if(e=f[u],e[1]==i.editTo){u=-1;break}else if(e[1]>i.editTo)break;u>-1&&f.splice(u-1,0,[h(i.editTo,n.chunks),i.editTo,i.origTo])}return f}function p(n,t){var r,s,f,u,h,o,i;if(n.dealigned||t){if(!n.orig.curOp)return n.orig.operation(function(){p(n,t)});for(n.dealigned=!1,r=n.mv.left==n?n.mv.right:n.mv.left,r&&(e(r),r.dealigned=!1),s=vt(n,r),f=n.mv.aligners,i=0;i<f.length;i++)f[i].clear();for(f.length=0,u=[n.orig,n.edit],h=[],r&&u.push(r.orig),i=0;i<u.length;i++)h.push(u[i].getScrollInfo().top);for(o=0;o<s.length;o++)yt(u,s[o],f);for(i=0;i<u.length;i++)u[i].scrollTo(null,h[i])}}function yt(n,t,i){for(var f,e,u=0,o=[],r=0;r<n.length;r++)t[r]!=null&&(f=n[r].heightAtLine(t[r],"local"),o[r]=f,u=Math.max(u,f));for(r=0;r<n.length;r++)t[r]!=null&&(e=u-o[r],e>1&&i.push(pt(n[r],t[r],e)))}function pt(n,t,i){var u=!0,r;return t>n.lastLine()&&(t--,u=!1),r=document.createElement("div"),r.className="CodeMirror-merge-spacer",r.style.height=i+"px",r.style.minWidth="1px",n.addLineWidget(t,r,{height:i,above:u})}function wt(n,t,i,u,f){var y=n.type=="left",p=n.orig.heightAtLine(t.origFrom,"local")-i,o,s,h,c,l,w,b,a,v,d,e;n.svg&&(o=p,s=n.edit.heightAtLine(t.editFrom,"local")-u,y&&(l=o,o=s,s=l),h=n.orig.heightAtLine(t.origTo,"local")-i,c=n.edit.heightAtLine(t.editTo,"local")-u,y&&(l=h,h=c,c=l),w=" C "+f/2+" "+s+" "+f/2+" "+o+" "+(f+2)+" "+o,b=" C "+f/2+" "+h+" "+f/2+" "+c+" -1 "+c,ht(n.svg.appendChild(document.createElementNS(k,"path")),"d","M -1 "+s+w+" L "+(f+2)+" "+h+b+" z","class",n.classes.connect));n.copyButtons&&(a=n.copyButtons.appendChild(r("div",n.type=="left"?"⇝":"⇜","CodeMirror-merge-copy")),v=n.mv.options.allowEditingOriginals,a.title=v?"Push to left":"Revert chunk",a.chunk=t,a.style.top=p+"px",v&&(d=n.orig.heightAtLine(t.editFrom,"local")-u,e=n.copyButtons.appendChild(r("div",n.type=="right"?"⇝":"⇜","CodeMirror-merge-copy-reverse")),e.title="Push to right",e.chunk={editFrom:t.origFrom,editTo:t.origTo,origFrom:t.editFrom,origTo:t.editTo},e.style.top=d+"px",n.type=="right"?e.style.left="2px":e.style.right="2px"))}function tt(n,t,r,u){n.diffOutOfDate||t.replaceRange(r.getRange(i(u.origFrom,0),i(u.origTo,0)),i(u.editFrom,0),i(u.editTo,0))}function it(t){var f=t.lockButton=r("div",null,"CodeMirror-merge-scrolllock"),e,u,i;f.title="Toggle locked scrolling";e=r("div",[f],"CodeMirror-merge-scrolllock-wrap");n.on(f,"click",function(){g(t,!t.lockScroll)});if(u=[e],t.mv.options.revertButtons!==!1){t.copyButtons=r("div",null,"CodeMirror-merge-copybuttons-"+t.type);n.on(t.copyButtons,"click",function(n){var i=n.target||n.srcElement;if(i.chunk){if(i.className=="CodeMirror-merge-copy-reverse"){tt(t,t.orig,t.edit,i.chunk);return}tt(t,t.edit,t.orig,i.chunk)}});u.unshift(t.copyButtons)}return t.mv.options.connect!="align"&&(i=document.createElementNS&&document.createElementNS(k,"svg"),i&&!i.createSVGRect&&(i=null),t.svg=i,i&&u.push(i)),t.gap=r("div",u,"CodeMirror-merge-gap")}function rt(n){return typeof n=="string"?n:n.getValue()}function ut(n,t){var r=w.diff_main(n,t),i,u;for(w.diff_cleanupSemantic(r),i=0;i<r.length;++i)u=r[i],u[1]?i&&r[i-1][0]==u[0]&&(r.splice(i--,1),r[i][1]+=u[1]):r.splice(i--,1);return r}function ft(n){for(var o,h,s=[],f=0,e=0,t=i(0,0),r=i(0,0),u=0;u<n.length;++u)if(o=n[u],h=o[0],h==DIFF_EQUAL){var c=ot(n,u)?0:1,a=t.line+c,p=r.line+c;l(t,o[1],null,r);var v=et(n,u)?1:0,y=t.line+v,w=r.line+v;y>a&&(u&&s.push({origFrom:e,origTo:p,editFrom:f,editTo:a}),f=y,e=w)}else l(h==DIFF_INSERT?t:r,o[1]);return(f<=t.line||e<=r.line)&&s.push({origFrom:e,origTo:r.line+1,editFrom:f,editTo:t.line+1}),s}function et(n,t){if(t==n.length-1)return!0;var i=n[t+1][1];return i.length==1||i.charCodeAt(0)!=10?!1:t==n.length-2?!0:(i=n[t+2][1],i.length>1&&i.charCodeAt(0)==10)}function ot(n,t){if(t==0)return!0;var i=n[t-1][1];return i.charCodeAt(i.length-1)!=10?!1:t==1?!0:(i=n[t-2][1],i.charCodeAt(i.length-1)==10)}function bt(n,t,i){for(var f,u,e,o,s=0;s<n.length;s++){var r=n[s],h=i?r.editFrom:r.origFrom,c=i?r.editTo:r.origTo;u==null&&(h>t?(u=r.editFrom,o=r.origFrom):c>t&&(u=r.editTo,o=r.origTo));c<=t?(f=r.editTo,e=r.origTo):h<=t&&(f=r.editFrom,e=r.origFrom)}return{edit:{before:f,after:u},orig:{before:e,after:o}}}function kt(n,t,r){function e(){f.clear();n.removeLineClass(t,"wrap","CodeMirror-merge-collapsed-line")}var u,f;return n.addLineClass(t,"wrap","CodeMirror-merge-collapsed-line"),u=document.createElement("span"),u.className="CodeMirror-merge-collapsed-widget",u.title="Identical text collapsed. Click to expand.",f=n.markText(i(t,0),i(r-1),{inclusiveLeft:!0,inclusiveRight:!0,replacedWith:u,clearOnEnter:!0}),u.addEventListener("click",e),{mark:f,clear:e}}function dt(n,t){function e(){for(var n=0;n<i.length;n++)i[n].clear()}for(var r,f,i=[],u=0;u<t.length;u++){r=t[u];f=kt(r.cm,r.line,r.line+n);i.push(f);f.mark.on("clear",e)}return i[0].mark}function st(n,t,i,r){for(var o,f,e,u=0;u<n.chunks.length;u++)for(o=n.chunks[u],f=o.editFrom-t;f<o.editTo+t;f++)e=f+i,e>=0&&e<r.length&&(r[e]=!1)}function gt(n,t){var c,l,i,u,f,o,a;typeof t!="number"&&(t=2);var r=[],s=n.editor(),e=s.firstLine();for(c=e,l=s.lastLine();c<=l;c++)r.push(!0);for(n.left&&st(n.left,t,e,r),n.right&&st(n.right,t,e,r),i=0;i<r.length;i++)if(r[i]){for(u=i+e,f=1;i<r.length-1&&r[i+1];i++,f++);if(f>t&&(o=[{line:u,cm:s}],n.left&&o.push({line:h(u,n.left.chunks),cm:n.left.orig}),n.right&&o.push({line:h(u,n.right.chunks),cm:n.right.orig}),a=dt(f,o),n.options.onCollapse))n.options.onCollapse(n,u,f,a)}}function r(n,t,i,r){var u=document.createElement(n),f;if(i&&(u.className=i),r&&(u.style.cssText=r),typeof t=="string")u.appendChild(document.createTextNode(t));else if(t)for(f=0;f<t.length;++f)u.appendChild(t[f]);return u}function c(n){for(var t=n.childNodes.length;t>0;--t)n.removeChild(n.firstChild)}function ht(n){for(var t=1;t<arguments.length;t+=2)n.setAttribute(arguments[t],arguments[t+1])}function b(n,t){t||(t={});for(var i in n)n.hasOwnProperty(i)&&(t[i]=n[i]);return t}function l(n,t,r,u){for(var e=r?i(n.line,n.ch):n,f=0,o;;){if(o=t.indexOf("\n",f),o==-1)break;++e.line;u&&++u.line;f=o+1}return e.ch=(f?0:e.ch)+(t.length-f),u&&(u.ch=(f?0:u.ch)+(t.length-f)),e}function ni(n,t){return(n.line-t.line||n.ch-t.ch)<0?n:t}function ti(n,t){return(n.line-t.line||n.ch-t.ch)>0?n:t}function ii(n,t){return n.line==t.line&&n.ch==t.ch}function ri(n,t,i){for(var u,f,r=n.length-1;r>=0;r--)if(u=n[r],f=(i?u.origTo:u.editTo)-1,f<t)return f}function ui(n,t,i){for(var u,f,r=0;r<n.length;r++)if(u=n[r],f=i?u.origFrom:u.editFrom,f>t)return f}function ct(t,i){var r=null,s=t.state.diffViews,c=t.getCursor().line,o,u,h,f;if(s)for(o=0;o<s.length;o++)u=s[o],h=t==u.orig,e(u),f=i<0?ri(u.chunks,c,h):ui(u.chunks,c,h),f!=null&&(r==null||(i<0?f>r:f<r))&&(r=f);if(r!=null)t.setCursor(r,0);else return n.Pass}var i=n.Pos,k="http://www.w3.org/2000/svg",u,o,w;s.prototype={constructor:s,init:function(t,i,r){this.edit=this.mv.edit;(this.edit.state.diffViews||(this.edit.state.diffViews=[])).push(this);this.orig=n(t,b({value:i,readOnly:!this.mv.options.allowEditingOriginals},b(r)));this.orig.state.diffViews=[this];this.diff=ut(rt(i),rt(r.value));this.chunks=ft(this.diff);this.diffOutOfDate=this.dealigned=!1;this.showDifferences=r.showDifferences!==!1;this.forceUpdate=lt(this);g(this,!0,!1);at(this)},setShowDifferences:function(n){n=n!==!1;n!=this.showDifferences&&(this.showDifferences=n,this.forceUpdate("full"))}};u=!1;o=n.MergeView=function(t,i){var y,l,a,nt,w,tt;if(!(this instanceof o))return new o(t,i);this.options=i;var k=i.origLeft,d=i.origRight==null?i.orig:i.origRight,g=k!=null,v=d!=null,rt=1+(g?1:0)+(v?1:0),e=[],h=this.left=null,c=this.right=null,ut=this;g&&(h=this.left=new s(this,"left"),y=r("div",null,"CodeMirror-merge-pane"),e.push(y),e.push(it(h)));l=r("div",null,"CodeMirror-merge-pane");e.push(l);v&&(c=this.right=new s(this,"right"),e.push(it(c)),a=r("div",null,"CodeMirror-merge-pane"),e.push(a));(v?a:l).className+=" CodeMirror-merge-pane-rightmost";e.push(r("div",null,null,"height: 0; clear: both;"));nt=this.wrap=t.appendChild(r("div",e,"CodeMirror-merge CodeMirror-merge-"+rt+"pane"));this.edit=n(l,b(i));h&&h.init(y,k,i);c&&c.init(a,d,i);i.collapseIdentical&&(u=!0,this.editor().operation(function(){gt(ut,i.collapseIdentical)}),u=!1);i.connect=="align"&&(this.aligners=[],p(this.left||this.right,!0));w=function(){h&&f(h);c&&f(c)};n.on(window,"resize",w);tt=setInterval(function(){for(var t=nt.parentNode;t&&t!=document.body;t=t.parentNode);t||(clearInterval(tt),n.off(window,"resize",w))},5e3)};o.prototype={constuctor:o,editor:function(){return this.edit},rightOriginal:function(){return this.right&&this.right.orig},leftOriginal:function(){return this.left&&this.left.orig},setShowDifferences:function(n){this.right&&this.right.setShowDifferences(n);this.left&&this.left.setShowDifferences(n)},rightChunks:function(){if(this.right)return e(this.right),this.right.chunks},leftChunks:function(){if(this.left)return e(this.left),this.left.chunks}};w=new t;n.commands.goNextDiff=function(n){return ct(n,1)};n.commands.goPrevDiff=function(n){return ct(n,-1)}});