(function(n){"use strict";function i(){var e=function(n){return n&&n[0]==="="?!0:!1},t=function(t,i,r,u,f,o,c){var a,b,v;if(t.formulasEnabled&&e(o)){var w=t.plugin.utils.translateCellCoords({row:r,col:u}),d=null,y=null,p=!1,l,k;if(!w)return;a=t.plugin.matrix.getItem(w);a&&(p=!!a.needUpdate,a.error&&(d=a.formula,l=a.error,p&&(l=null)));(o&&o[0]==="="||p)&&(y=o.substr(1).toUpperCase(),l&&y===d||(b=a,b||(a={id:w,formula:y},b=t.plugin.matrix.addItem(a)),v=t.plugin.parse(y,{row:r,col:u,id:w}),p=v.error==="#NEED_UPDATE",t.plugin.matrix.updateItem(b,{formula:y,value:v.result,error:v.error,needUpdate:p}),l=v.error,k=v.result,o=l||k));l&&(o?o=l:l=null);t.plugin.utils.isSet(l)?n.Dom.addClass(i,"formula-error"):t.plugin.utils.isSet(k)&&(n.Dom.removeClass(i,"formula-error"),n.Dom.addClass(i,"formula"))}c.type==="numeric"?h.renderer.apply(this,[t,i,r,u,f,o,c]):s.renderer.apply(this,[t,i,r,u,f,o,c])},i=function(n,t){var i=this,r;i.formulasEnabled&&(t==="edit"||t==="undo"||t==="autofill")&&(r=!1,n.forEach(function(n){var e=n[0],o=n[1],s=n[2],t=n[3],u=i.plugin.utils.translateCellCoords({row:e,col:o}),f;(t[0]!=="="||s!==t)&&(i.plugin.matrix.removeItem(u),f=i.plugin.matrix.getDependencies(u),f.forEach(function(n){i.plugin.matrix.updateItem(n,{needUpdate:!0})}),r=!0)}),r&&i.render())},r=function(n,t,i,r,u,f){var a=this,v=n.row,y=n.col,p=i[v][y],e=0,s=i.length,h=i?i[0].length:0,o,c,l;return p[0]==="="?(["down","up"].indexOf(t)!==-1?e=s*u.row:["right","left"].indexOf(t)!==-1&&(e=h*u.col),{value:a.plugin.utils.updateFormula(p,t,e),iterators:u}):(s>=2||h>=2)&&(o=a.plugin.helper.number(p),a.plugin.utils.isNumber(o))?(["down","up"].indexOf(t)!==-1?(e=r[0][y],t==="down"?o+=e*s*u.row:(c=(f.row-v)%s,l=c>0?s-c:0,o=a.plugin.helper.number(i[l][y]),o+=e*s*u.row,u.row>1&&l+1===s&&u.row--)):["right","left"].indexOf(t)!==-1&&(e=r[v][0],t==="right"?o+=e*h*u.col:(c=(f.col-y)%h,l=c>0?h-c:0,o=a.plugin.helper.number(i[v][l]),o+=e*h*(u.col||1),u.col>1&&l+1===h&&u.col--)),{value:o,iterators:u}):{value:p,iterators:u}},u=function(n,t,i){var r,u;if(!i&&(r=this,u=r.plugin.utils.isArray(r.getSelected())?r.getSelected()[0]:undefined,!r.plugin.utils.isUndefined(u))){var e=u>=n?"before":"after",o=r.plugin.matrix.getRefItemsToRow(n),s=1,f=[];o.forEach(function(t){var i=r.plugin.matrix.getItem(t),c=r.plugin.utils.changeFormula(i.formula,1,{row:n}),o=t,h;c!==i.formula&&((e==="before"&&u<=i.row||e==="after"&&u<i.row)&&(o=r.plugin.utils.changeRowIndex(t,s)),h=r.plugin.utils.cellCoords(o),o!==t&&r.plugin.matrix.removeItem(t),f.push([h.row,h.col,"="+c]))});o&&r.plugin.matrix.removeItemsBelowRow(n);f&&r.setDataAtCell(f)}},f=function(n){var t=this,i=t.plugin.utils.isArray(t.getSelected())?t.getSelected()[1]:undefined;if(!t.plugin.utils.isUndefined(i)){var u=t.plugin.matrix.getRefItemsToColumn(n),e=1,f=i>=n?"before":"after",r=[];u.forEach(function(u){var o=t.plugin.matrix.getItem(u),c=t.plugin.utils.changeFormula(o.formula,1,{col:n}),s=u,h;c!==o.formula&&((f==="before"&&i<=o.col||f==="after"&&i<o.col)&&(s=t.plugin.utils.changeColIndex(u,e)),h=t.plugin.utils.cellCoords(s),s!==u&&t.plugin.matrix.removeItem(u),r.push([h.row,h.col,"="+c]))});u&&t.plugin.matrix.removeItemsBelowCol(n);r&&t.setDataAtCell(r)}},o={renderer:t,editor:n.editors.TextEditor,dataType:"formula"},s={renderer:n.renderers.TextRenderer,editor:n.editors.TextEditor},h={renderer:n.renderers.NumericRenderer,editor:n.editors.NumericEditor};this.init=function(){var e=this,s;e.formulasEnabled=!!e.getSettings().formulas;e.formulasEnabled?(s={cellValue:e.getDataAtCell},e.plugin=new ruleJS,e.plugin.init(),e.plugin.custom=s,n.cellTypes.formula=o,n.TextCell.renderer=t,n.NumericCell.renderer=t,e.addHook("afterChange",i),e.addHook("beforeAutofillInsidePopulate",r),e.addHook("afterCreateRow",u),e.addHook("afterCreateCol",f)):(e.removeHook("afterChange",i),e.removeHook("beforeAutofillInsidePopulate",r),e.removeHook("afterCreateRow",u),e.removeHook("afterCreateCol",f))}}var t=new i;n.hooks.add("beforeInit",t.init);n.hooks.add("afterUpdateSettings",function(){t.init.call(this,"afterUpdateSettings")})})(Handsontable);